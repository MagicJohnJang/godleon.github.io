<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-tw">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/blog/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/blog/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/blog/css/main.css?v=5.1.3" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/blog/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Elasticsearch,">










<meta name="description" content="此篇文章是在極客時間學習 Elasticsearch 課程時留下的一些學習筆記，主要內容包含 Elasticsearch 深入搜索">
<meta name="keywords" content="Elasticsearch">
<meta property="og:type" content="article">
<meta property="og:title" content="[Elasticsearch] 深入搜索">
<meta property="og:url" content="https://godleon.github.io/blog/Elasticsearch/Elasticsearch-advanced-search/index.html">
<meta property="og:site_name" content="小信豬的原始部落">
<meta property="og:description" content="此篇文章是在極客時間學習 Elasticsearch 課程時留下的一些學習筆記，主要內容包含 Elasticsearch 深入搜索">
<meta property="og:locale" content="zh-tw">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_tf-idf-scoring.png">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_bm25.png">
<meta property="og:updated_time" content="2020-02-12T09:17:58.144Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="[Elasticsearch] 深入搜索">
<meta name="twitter:description" content="此篇文章是在極客時間學習 Elasticsearch 課程時留下的一些學習筆記，主要內容包含 Elasticsearch 深入搜索">
<meta name="twitter:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_tf-idf-scoring.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/blog/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://godleon.github.io/blog/Elasticsearch/Elasticsearch-advanced-search/">





  <title>[Elasticsearch] 深入搜索 | 小信豬的原始部落</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-703592-7', 'auto');
  ga('send', 'pageview');
</script>





</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-tw">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/blog/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">小信豬的原始部落</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/blog/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首頁
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/blog/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            標籤
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/blog/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分類
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/blog/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            歸檔
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            檢索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://godleon.github.io/blog/blog/Elasticsearch/Elasticsearch-advanced-search/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="godleon">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小信豬的原始部落">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">[Elasticsearch] 深入搜索</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              
              <time title="創建於" itemprop="dateCreated datePublished" datetime="2019-11-09T00:00:00+00:00">
                2019-11-09
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Elasticsearch/" itemprop="url" rel="index">
                    <span itemprop="name">Elasticsearch</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/blog/Elasticsearch/Elasticsearch-advanced-search/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="Elasticsearch/Elasticsearch-advanced-search/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          
              <div class="post-description">
                  此篇文章是在極客時間學習 Elasticsearch 課程時留下的一些學習筆記，主要內容包含 Elasticsearch 深入搜索
              </div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>以下的內容其實不少，先把重點抓到這裡來：</p>
<ul>
<li><p>term query 用於數據化結構的查詢</p>
</li>
<li><p>Full text 使用 match 查詢</p>
</li>
<li><p>bool query 是種複合查詢，可以結合 term query &amp; full text query</p>
</li>
<li><p>multi-match + best field = disjunction max query</p>
</li>
</ul>
<h1 id="Term-Query-amp-Full-Text-Query"><a href="#Term-Query-amp-Full-Text-Query" class="headerlink" title="Term Query &amp; Full Text Query"></a>Term Query &amp; Full Text Query</h1><h2 id="Term-Query"><a href="#Term-Query" class="headerlink" title="Term Query"></a><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-term-query.html" target="_blank" rel="noopener">Term Query</a></h2><ul>
<li><p>Term 是表達語意的最小單位，搜尋或是利用自然語言進行處理時都需要處理 term</p>
</li>
<li><p>Term Level Query 包含 <strong>Term Query</strong> / <strong>Range Query</strong> / <strong>Exists Query</strong> / <strong>Prefix Query</strong> / <strong>Wildcard Query</strong></p>
</li>
<li><p>當 ES 接收到 term query 時，對輸入不會做分詞，並將輸入當作一個整體在 inverted index 中找到精確的詞項，並使用相關度算分的機制來計算分數</p>
</li>
<li><p>若是不需要算分，則可以利用 <code>constant score</code> 將查詢轉換成 <code>filter</code>，並利用 cache 來提高效能</p>
</li>
</ul>
<p>以下使用範例說明 term 查詢所需要注意的事項：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//新增 index</span></span><br><span class="line">PUT products</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"settings"</span>: &#123;</span><br><span class="line">    <span class="attr">"number_of_shards"</span>: <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//新增三筆資料</span></span><br><span class="line">POST /products/_bulk</span><br><span class="line">&#123; <span class="attr">"index"</span>: &#123; <span class="attr">"_id"</span>: <span class="number">1</span> &#125;&#125;</span><br><span class="line">&#123; <span class="attr">"productID"</span> : <span class="string">"XHDK-A-1293-#fJ3"</span>,<span class="attr">"desc"</span>:<span class="string">"iPhone"</span> &#125;</span><br><span class="line">&#123; <span class="attr">"index"</span>: &#123; <span class="attr">"_id"</span>: <span class="number">2</span> &#125;&#125;</span><br><span class="line">&#123; <span class="attr">"productID"</span> : <span class="string">"KDKE-B-9947-#kL5"</span>,<span class="attr">"desc"</span>:<span class="string">"iPad"</span> &#125;</span><br><span class="line">&#123; <span class="attr">"index"</span>: &#123; <span class="attr">"_id"</span>: <span class="number">3</span> &#125;&#125;</span><br><span class="line">&#123; <span class="attr">"productID"</span> : <span class="string">"JODL-X-1937-#pV7"</span>,<span class="attr">"desc"</span>:<span class="string">"MBP"</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//檢視 index 的 setting &amp; mapping 資訊</span></span><br><span class="line">GET /products</span><br><span class="line"></span><br><span class="line"><span class="comment">//搜尋 "iPhone" =&gt; 找不到資料，因為預設的 index analyzer 分詞後會將每個單字轉小寫</span></span><br><span class="line"><span class="comment">//搜尋 "iphone" =&gt; 改成小寫，順利找到資料</span></span><br><span class="line">POST /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"term"</span>: &#123;</span><br><span class="line">      <span class="attr">"desc"</span>: &#123;</span><br><span class="line">        <span class="attr">"value"</span>: <span class="string">"iPhone"</span></span><br><span class="line">        <span class="comment">//"value":"iphone"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//改成在 "desc.keyword" field 含有大寫字母的 "iPohne"，可以找到資料</span></span><br><span class="line"><span class="comment">//因為 keyword field 會完整保留原始資料</span></span><br><span class="line"><span class="comment">//反而使用小寫 "iphone" 是無法找到資料的</span></span><br><span class="line">POST /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"term"</span>: &#123;</span><br><span class="line">      <span class="attr">"desc.keyword"</span>: &#123;</span><br><span class="line">        <span class="attr">"value"</span>: <span class="string">"iPhone"</span></span><br><span class="line">        <span class="comment">//"value":"iphone"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//跟上面的範例相同，大寫的搜尋條件無法找到資料</span></span><br><span class="line"><span class="comment">//因為預設的 analyzer 會作小寫處理</span></span><br><span class="line">POST /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"term"</span>: &#123;</span><br><span class="line">      <span class="attr">"productID"</span>: &#123;</span><br><span class="line">        <span class="attr">"value"</span>: <span class="string">"XHDK-A-1293-#fJ3"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用 keyword field 就可以正確使用大寫的搜尋條件找到資料了</span></span><br><span class="line">POST /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//"explain": true,</span></span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"term"</span>: &#123;</span><br><span class="line">      <span class="attr">"productID.keyword"</span>: &#123;</span><br><span class="line">        <span class="attr">"value"</span>: <span class="string">"XHDK-A-1293-#fJ3"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//透過 "constant_score" 將查詢轉換成 filter 來提昇查詢效率</span></span><br><span class="line"><span class="comment">//因為算分過程被忽略，所有搜尋結果都是 1 分</span></span><br><span class="line">POST /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"constant_score"</span>: &#123;</span><br><span class="line">      <span class="attr">"filter"</span>: &#123;</span><br><span class="line">        <span class="attr">"term"</span>: &#123;</span><br><span class="line">          <span class="attr">"productID.keyword"</span>: <span class="string">"XHDK-A-1293-#fJ3"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Full-Text-Query"><a href="#Full-Text-Query" class="headerlink" title="Full Text Query"></a><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/full-text-queries.html" target="_blank" rel="noopener">Full Text Query</a></h2><ul>
<li><p>Full text query 可以是 match query, match phrase query, query string query … 等等，詳細的列表可以參考<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/full-text-queries.html" target="_blank" rel="noopener">官網資料</a></p>
</li>
<li><p>index &amp; query 都會進行分詞，查詢字串會先傳給一個合適的 analyzer，並生成用來查詢的 term list</p>
</li>
<li><p>分詞後的 term list 會被逐一拿來查詢，並將最後結果合併後，為每個 document 計算出一個分數</p>
</li>
</ul>
<p>以下是幾個簡單範例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//若只有 query，預設的 operator 是 or，因此會找到多筆資料</span></span><br><span class="line"><span class="comment">//搭配 operator or minimum_should_match，可以讓查詢結果更準確</span></span><br><span class="line">POST movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"match"</span>: &#123;</span><br><span class="line">      <span class="attr">"title"</span>: &#123;</span><br><span class="line">        <span class="comment">//"operator": "and", </span></span><br><span class="line">        <span class="comment">//"minimum_should_match": 2,</span></span><br><span class="line">        <span class="attr">"query"</span>: <span class="string">"Matrix reloaded"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//也可以使用 "match_phrase" 搭配 "slop" 讓搜尋結果更準確</span></span><br><span class="line">POST movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"match_phrase"</span>: &#123;</span><br><span class="line">      <span class="attr">"title"</span>: &#123;</span><br><span class="line">        <span class="comment">//"slop": 1,</span></span><br><span class="line">        <span class="attr">"query"</span>: <span class="string">"Matrix reloaded"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="結構化搜尋"><a href="#結構化搜尋" class="headerlink" title="結構化搜尋"></a>結構化搜尋</h1><h2 id="結構化數據"><a href="#結構化數據" class="headerlink" title="結構化數據"></a>結構化數據</h2><ul>
<li><p>像是 date, boolean, number … 這一類的數據都是屬於結構化的</p>
</li>
<li><p>有些 text 也屬於結構化的，例如：顏色(red, green, blue)、tag(distributed, search)、特定編碼….只要有遵守規定產生的 text，都可以算是結構化的格式</p>
</li>
</ul>
<blockquote>
<p>而結構化搜尋就是對結構化的數據進行搜尋</p>
</blockquote>
<ul>
<li><p>結構化的 text 可以做精確比對(term query) or 部份比對(prefix query)</p>
</li>
<li><p>結構化的搜尋結果只會有 “true” or “false” 兩種值，並且可以根據需求來決定是否做 scoring 的行為</p>
</li>
</ul>
<p>以下是一些簡單範例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">#結構化搜索，精確匹配</span><br><span class="line">DELETE products</span><br><span class="line"></span><br><span class="line"><span class="comment">//加入資料</span></span><br><span class="line"><span class="comment">//並不是所有資料都有 date 欄位</span></span><br><span class="line">POST /products/_bulk</span><br><span class="line">&#123; <span class="attr">"index"</span>: &#123; <span class="attr">"_id"</span>: <span class="number">1</span> &#125;&#125;</span><br><span class="line">&#123; <span class="attr">"price"</span> : <span class="number">10</span>,<span class="attr">"avaliable"</span>:<span class="literal">true</span>,<span class="attr">"date"</span>:<span class="string">"2018-01-01"</span>, <span class="attr">"productID"</span> : <span class="string">"XHDK-A-1293-#fJ3"</span> &#125;</span><br><span class="line">&#123; <span class="attr">"index"</span>: &#123; <span class="attr">"_id"</span>: <span class="number">2</span> &#125;&#125;</span><br><span class="line">&#123; <span class="attr">"price"</span> : <span class="number">20</span>,<span class="attr">"avaliable"</span>:<span class="literal">true</span>,<span class="attr">"date"</span>:<span class="string">"2019-01-01"</span>, <span class="attr">"productID"</span> : <span class="string">"KDKE-B-9947-#kL5"</span> &#125;</span><br><span class="line">&#123; <span class="attr">"index"</span>: &#123; <span class="attr">"_id"</span>: <span class="number">3</span> &#125;&#125;</span><br><span class="line">&#123; <span class="attr">"price"</span> : <span class="number">30</span>,<span class="attr">"avaliable"</span>:<span class="literal">true</span>, <span class="attr">"productID"</span> : <span class="string">"JODL-X-1937-#pV7"</span> &#125;</span><br><span class="line">&#123; <span class="attr">"index"</span>: &#123; <span class="attr">"_id"</span>: <span class="number">4</span> &#125;&#125;</span><br><span class="line">&#123; <span class="attr">"price"</span> : <span class="number">30</span>,<span class="attr">"avaliable"</span>:<span class="literal">false</span>, <span class="attr">"productID"</span> : <span class="string">"QQPX-R-3956-#aD8"</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//查詢 dynamic mapping 後的結果</span></span><br><span class="line">GET products/_mapping</span><br><span class="line"></span><br><span class="line"><span class="comment">//進行 term query，並計算出分數</span></span><br><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"profile"</span>: <span class="string">"true"</span>,</span><br><span class="line">  <span class="attr">"explain"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"term"</span>: &#123;</span><br><span class="line">      <span class="attr">"avaliable"</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//進行 term query，但使用 filter context，因此不算分</span></span><br><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"profile"</span>: <span class="string">"true"</span>,</span><br><span class="line">  <span class="attr">"explain"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"constant_score"</span>: &#123;</span><br><span class="line">      <span class="attr">"filter"</span>: &#123;</span><br><span class="line">        <span class="attr">"term"</span>: &#123;</span><br><span class="line">          <span class="attr">"avaliable"</span>: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用 range 查詢 &amp; 搭配 filter context 跳過算分步驟</span></span><br><span class="line">GET products/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span> : &#123;</span><br><span class="line">    <span class="attr">"constant_score"</span> : &#123;</span><br><span class="line">      <span class="attr">"filter"</span> : &#123;</span><br><span class="line">        <span class="attr">"range"</span> : &#123;</span><br><span class="line">          <span class="attr">"price"</span> : &#123;</span><br><span class="line">            <span class="attr">"gte"</span> : <span class="number">20</span>,</span><br><span class="line">            <span class="attr">"lte"</span>  : <span class="number">30</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用特殊字元(y-&gt;年)處理日期相關查詢</span></span><br><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span> : &#123;</span><br><span class="line">    <span class="attr">"constant_score"</span> : &#123;</span><br><span class="line">      <span class="attr">"filter"</span> : &#123;</span><br><span class="line">        <span class="attr">"range"</span> : &#123;</span><br><span class="line">          <span class="attr">"date"</span> : &#123;</span><br><span class="line">            <span class="attr">"gte"</span> : <span class="string">"now-1y"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// =========== multi-value field 的處理 ===========</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//若是 field 中包含多個 text</span></span><br><span class="line">POST /movies/_bulk</span><br><span class="line">&#123; <span class="attr">"index"</span>: &#123; <span class="attr">"_id"</span>: <span class="number">1</span> &#125;&#125;</span><br><span class="line">&#123; <span class="attr">"title"</span> : <span class="string">"Father of the Bridge Part II"</span>,<span class="attr">"year"</span>:<span class="number">1995</span>, <span class="attr">"genre"</span>:<span class="string">"Comedy"</span>&#125;</span><br><span class="line">&#123; <span class="attr">"index"</span>: &#123; <span class="attr">"_id"</span>: <span class="number">2</span> &#125;&#125;</span><br><span class="line">&#123; <span class="attr">"title"</span> : <span class="string">"Dave"</span>,<span class="attr">"year"</span>:<span class="number">1993</span>,<span class="attr">"genre"</span>:[<span class="string">"Comedy"</span>,<span class="string">"Romance"</span>] &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//由於 genere 為 multi-value field</span></span><br><span class="line"><span class="comment">//因此以下搜尋會將 genre 中有包涵 Comedy 的資料全部顯示出來</span></span><br><span class="line">POST movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"constant_score"</span>: &#123;</span><br><span class="line">      <span class="attr">"filter"</span>: &#123;</span><br><span class="line">        <span class="attr">"term"</span>: &#123;</span><br><span class="line">          <span class="attr">"genre.keyword"</span>: <span class="string">"Comedy"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="搜索的相關性算分"><a href="#搜索的相關性算分" class="headerlink" title="搜索的相關性算分"></a>搜索的相關性算分</h1><h2 id="相關性-amp-相關性算分"><a href="#相關性-amp-相關性算分" class="headerlink" title="相關性 &amp; 相關性算分"></a>相關性 &amp; 相關性算分</h2><ul>
<li><p><strong>搜尋的相關性算分</strong>描述一個 document 與查詢語句相符的程度，ES 會對每個符合查詢條件的結果進行算分，並放到 _score field 中</p>
</li>
<li><p>分數的是要用在搜尋結果排序中，在 ES5 之前使用 <code>TF-IDF</code> 算分，後面的版本使用 <code>BM 25</code></p>
</li>
</ul>
<h2 id="Term-Frequency-詞頻-amp-逆文檔頻率-Inverse-Document-Frequency-IDF"><a href="#Term-Frequency-詞頻-amp-逆文檔頻率-Inverse-Document-Frequency-IDF" class="headerlink" title="Term Frequency (詞頻) &amp; 逆文檔頻率(Inverse Document Frequency, IDF)"></a>Term Frequency (詞頻) &amp; 逆文檔頻率(Inverse Document Frequency, IDF)</h2><ul>
<li><p>檢索詞在一篇 document 中出現的頻率 = <code>檢索詞出現的次數 / document 總字數</code></p>
</li>
<li><p>衡量查詢 &amp; 結果 document 相關性的簡單方法就是將每個 term 的 TF 相加 = <code>TF(word1) + TF(word2) + TF(word3)</code></p>
</li>
<li><p>stop word 出現太多，一般計算分數時不會列入考慮</p>
</li>
<li><p>IDF = <code>log(全部 document 數量 / 檢索詞出現過的 document 總數)</code></p>
</li>
<li><p><code>TF-IDF</code> 其實就是從 sum(TF) 變成了 sum(TF + IDF)</p>
</li>
<li><p>現代的 search engine 大多以 TF-IDF 為基礎再加上大量的優化</p>
</li>
</ul>
<p><img src="/blog/images/Elasticsearch/es_tf-idf-scoring.png" alt="Elasticsearch - TD-IDF"></p>
<ul>
<li>從上圖可見，TF-IDF 的評分公式，除了 TD &amp; IDF 之外，還包涵了 <code>boosting</code> &amp; <code>field length(欄位長度)</code> 兩項</li>
</ul>
<h2 id="BM-25"><a href="#BM-25" class="headerlink" title="BM 25"></a>BM 25</h2><p><img src="/blog/images/Elasticsearch/es_bm25.png" alt="Elasticsearch - BM 25"></p>
<ul>
<li>跟 TF-IDF 相比，當 TF 無限增加時，BM 25 算分會趨近於某個值，不會無限變大</li>
</ul>
<h2 id="Boosting-Relevance"><a href="#Boosting-Relevance" class="headerlink" title="Boosting Relevance"></a>Boosting Relevance</h2><ul>
<li><p>boosting 是可以用來控制相關度的一種方式，可用在 index, field, 或是查詢子條件中</p>
</li>
<li><p>當 <code>boost &gt; 1</code> 可提昇相關度，<code>0 &lt; boost &lt; 1</code> 計算分數的權重相對降低, boost &lt; 0，貢獻為負分</p>
</li>
</ul>
<p>以下是一個簡單的範例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">POST testscore/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"boosting"</span> : &#123;</span><br><span class="line">      <span class="attr">"positive"</span> : &#123;</span><br><span class="line">        <span class="attr">"term"</span> : &#123;</span><br><span class="line">          <span class="attr">"content"</span> : <span class="string">"elasticsearch"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"negative"</span> : &#123;</span><br><span class="line">        <span class="attr">"term"</span> : &#123;</span><br><span class="line">          <span class="attr">"content"</span> : <span class="string">"like"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"negative_boost"</span> : <span class="number">0.2</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Query-amp-Filtering-與多字符串多字段查詢"><a href="#Query-amp-Filtering-與多字符串多字段查詢" class="headerlink" title="Query &amp; Filtering 與多字符串多字段查詢"></a>Query &amp; Filtering 與多字符串多字段查詢</h1><h2 id="Query-Context-amp-Filter-Context"><a href="#Query-Context-amp-Filter-Context" class="headerlink" title="Query Context &amp; Filter Context"></a>Query Context &amp; Filter Context</h2><ul>
<li><p>在 Elasticsearch 中，有 Query &amp; Filter 兩種不同的 Context (<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-filter-context.html" target="_blank" rel="noopener">官網文件</a>)</p>
</li>
<li><p>Query Context 會對相關性進行算分</p>
</li>
<li><p>Filter Context 不會進行算分，但可利用 cache 來取得更好的效能</p>
</li>
</ul>
<h2 id="Bool-Query"><a href="#Bool-Query" class="headerlink" title="Bool Query"></a>Bool Query</h2><ul>
<li>一個 bool query 是一個 or 多個查詢子句所組成</li>
</ul>
<table>
<thead>
<tr>
<th>子句</th>
<th>效果</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>must</code></td>
<td>(<strong>Query Context</strong>) 必須符合，對算分有貢獻</td>
</tr>
<tr>
<td><code>should</code></td>
<td>(<strong>Query Context</strong>) 選擇性符合，對算分有貢獻</td>
</tr>
<tr>
<td><code>must_not</code></td>
<td>(<strong>Filter Context</strong>) 必須不能符合，對算分無貢獻</td>
</tr>
<tr>
<td><code>filter</code></td>
<td>(<strong>Filter Context</strong>) 必須符合，對算分無貢獻</td>
</tr>
</tbody>
</table>
<ul>
<li>bool query 中的每一個查詢子句得到的分數都會被合併成總和的相關性評分</li>
</ul>
<p>關於查詢的語法，有以下幾點需要注意：</p>
<ul>
<li><p>子查詢可以以任意的順序出現</p>
</li>
<li><p>可用 list 的方式在一個子查詢中加入多個查詢</p>
</li>
<li><p>若 bool query 中沒有 must 條件，那 should </p>
</li>
</ul>
<h2 id="範例"><a href="#範例" class="headerlink" title="範例"></a>範例</h2><h3 id="包含多個子查詢的-Bool-Query"><a href="#包含多個子查詢的-Bool-Query" class="headerlink" title="包含多個子查詢的 Bool Query"></a>包含多個子查詢的 Bool Query</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//新增多筆資料</span></span><br><span class="line">POST /products/_bulk</span><br><span class="line">&#123; <span class="attr">"index"</span>: &#123; <span class="attr">"_id"</span>: <span class="number">1</span> &#125;&#125;</span><br><span class="line">&#123; <span class="attr">"price"</span> : <span class="number">10</span>,<span class="attr">"avaliable"</span>:<span class="literal">true</span>,<span class="attr">"date"</span>:<span class="string">"2018-01-01"</span>, <span class="attr">"productID"</span> : <span class="string">"XHDK-A-1293-#fJ3"</span> &#125;</span><br><span class="line">&#123; <span class="attr">"index"</span>: &#123; <span class="attr">"_id"</span>: <span class="number">2</span> &#125;&#125;</span><br><span class="line">&#123; <span class="attr">"price"</span> : <span class="number">20</span>,<span class="attr">"avaliable"</span>:<span class="literal">true</span>,<span class="attr">"date"</span>:<span class="string">"2019-01-01"</span>, <span class="attr">"productID"</span> : <span class="string">"KDKE-B-9947-#kL5"</span> &#125;</span><br><span class="line">&#123; <span class="attr">"index"</span>: &#123; <span class="attr">"_id"</span>: <span class="number">3</span> &#125;&#125;</span><br><span class="line">&#123; <span class="attr">"price"</span> : <span class="number">30</span>,<span class="attr">"avaliable"</span>:<span class="literal">true</span>, <span class="attr">"productID"</span> : <span class="string">"JODL-X-1937-#pV7"</span> &#125;</span><br><span class="line">&#123; <span class="attr">"index"</span>: &#123; <span class="attr">"_id"</span>: <span class="number">4</span> &#125;&#125;</span><br><span class="line">&#123; <span class="attr">"price"</span> : <span class="number">30</span>,<span class="attr">"avaliable"</span>:<span class="literal">false</span>, <span class="attr">"productID"</span> : <span class="string">"QQPX-R-3956-#aD8"</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//bool query，使用多個子查詢</span></span><br><span class="line">POST /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"bool"</span> : &#123;</span><br><span class="line">      <span class="comment">//Query Context</span></span><br><span class="line">      <span class="attr">"must"</span> : &#123;</span><br><span class="line">        <span class="attr">"term"</span> : &#123; <span class="attr">"price"</span> : <span class="string">"30"</span> &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">//Filter Context</span></span><br><span class="line">      <span class="attr">"filter"</span>: &#123;</span><br><span class="line">        <span class="attr">"term"</span> : &#123; <span class="attr">"avaliable"</span> : <span class="string">"true"</span> &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">//Filter Context</span></span><br><span class="line">      <span class="attr">"must_not"</span> : &#123;</span><br><span class="line">        <span class="attr">"range"</span> : &#123;</span><br><span class="line">          <span class="attr">"price"</span> : &#123; <span class="attr">"lte"</span> : <span class="number">10</span> &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">//Query Context</span></span><br><span class="line">      <span class="attr">"should"</span> : [</span><br><span class="line">        &#123; <span class="attr">"term"</span> : &#123; <span class="attr">"productID.keyword"</span> : <span class="string">"JODL-X-1937-#pV7"</span> &#125; &#125;,</span><br><span class="line">        &#123; <span class="attr">"term"</span> : &#123; <span class="attr">"productID.keyword"</span> : <span class="string">"XHDK-A-1293-#fJ3"</span> &#125; &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"minimum_should_match"</span> :<span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="複雜的-Bool-Query"><a href="#複雜的-Bool-Query" class="headerlink" title="複雜的 Bool Query"></a>複雜的 Bool Query</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">POST /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"bool"</span>: &#123;</span><br><span class="line">      <span class="attr">"must"</span>: &#123;</span><br><span class="line">        <span class="attr">"term"</span>: &#123;</span><br><span class="line">          <span class="attr">"price"</span>: <span class="string">"30"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">//在 bool query 的子查詢中再塞進一個 bool query</span></span><br><span class="line">      <span class="attr">"should"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"bool"</span>: &#123;</span><br><span class="line">            <span class="attr">"must_not"</span>: &#123;</span><br><span class="line">              <span class="attr">"term"</span>: &#123;</span><br><span class="line">                <span class="attr">"avaliable"</span>: <span class="string">"false"</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"minimum_should_match"</span>: <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="不同的算分標準"><a href="#不同的算分標準" class="headerlink" title="不同的算分標準"></a>不同的算分標準</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">POST /animals/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"bool"</span>: &#123;</span><br><span class="line">      <span class="attr">"should"</span>: [</span><br><span class="line">        &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"text"</span>: <span class="string">"brown"</span> &#125;&#125;,</span><br><span class="line">        &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"text"</span>: <span class="string">"red"</span> &#125;&#125;,</span><br><span class="line">        &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"text"</span>: <span class="string">"quick"</span>   &#125;&#125;,</span><br><span class="line">        &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"text"</span>: <span class="string">"dog"</span>   &#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /animals/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"bool"</span>: &#123;</span><br><span class="line">      <span class="attr">"should"</span>: [</span><br><span class="line">        &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"text"</span>: <span class="string">"quick"</span> &#125;&#125;,</span><br><span class="line">        &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"text"</span>: <span class="string">"dog"</span>   &#125;&#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">//將同類型的條件分類在另外一個 bool query 中</span></span><br><span class="line">          <span class="comment">//會讓相關性分數的計算更加準確</span></span><br><span class="line">          <span class="attr">"bool"</span>:&#123;</span><br><span class="line">            <span class="attr">"should"</span>:[</span><br><span class="line">               &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"text"</span>: <span class="string">"brown"</span> &#125;&#125;,</span><br><span class="line">                 &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"text"</span>: <span class="string">"brown"</span> &#125;&#125;,</span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="搭配-boosting-進行查詢"><a href="#搭配-boosting-進行查詢" class="headerlink" title="搭配 boosting 進行查詢"></a>搭配 boosting 進行查詢</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">DELETE news</span><br><span class="line"></span><br><span class="line"><span class="comment">//新增多筆資料</span></span><br><span class="line">POST /news/_bulk</span><br><span class="line">&#123; <span class="attr">"index"</span>: &#123; <span class="attr">"_id"</span>: <span class="number">1</span> &#125;&#125;</span><br><span class="line">&#123; <span class="attr">"content"</span>:<span class="string">"Apple Mac"</span> &#125;</span><br><span class="line">&#123; <span class="attr">"index"</span>: &#123; <span class="attr">"_id"</span>: <span class="number">2</span> &#125;&#125;</span><br><span class="line">&#123; <span class="attr">"content"</span>:<span class="string">"Apple iPad"</span> &#125;</span><br><span class="line">&#123; <span class="attr">"index"</span>: &#123; <span class="attr">"_id"</span>: <span class="number">3</span> &#125;&#125;</span><br><span class="line">&#123; <span class="attr">"content"</span>:<span class="string">"Apple employee like Apple Pie and Apple Juice"</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//若是想要搜尋的是與 apple computer 相關的資訊</span></span><br><span class="line"><span class="comment">//最後一筆與食物相關的訊息會變成搜尋結果第一筆，因為 apple 出現次數最多</span></span><br><span class="line">POST news/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"bool"</span>: &#123;</span><br><span class="line">      <span class="attr">"must"</span>: &#123;</span><br><span class="line">        <span class="attr">"match"</span>:&#123;<span class="attr">"content"</span>:<span class="string">"apple"</span>&#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//限制食物相關訊息不能出現</span></span><br><span class="line">POST news/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"bool"</span>: &#123;</span><br><span class="line">      <span class="attr">"must"</span>: &#123;</span><br><span class="line">        <span class="attr">"match"</span>:&#123;<span class="attr">"content"</span>:<span class="string">"apple"</span>&#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"must_not"</span>: &#123;</span><br><span class="line">        <span class="attr">"match"</span>:&#123;<span class="attr">"content"</span>:<span class="string">"pie"</span>&#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//希望 apple 關鍵字的訊息都出現</span></span><br><span class="line"><span class="comment">//但透過 boosting 的設定讓食物相關訊息分數較低</span></span><br><span class="line">POST news/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"boosting"</span>: &#123;</span><br><span class="line">      <span class="attr">"positive"</span>: &#123;</span><br><span class="line">        <span class="attr">"match"</span>: &#123;</span><br><span class="line">          <span class="attr">"content"</span>: <span class="string">"apple"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"negative"</span>: &#123;</span><br><span class="line">        <span class="attr">"match"</span>: &#123;</span><br><span class="line">          <span class="attr">"content"</span>: <span class="string">"pie"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"negative_boost"</span>: <span class="number">0.5</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="單字符串多字段查詢：Disjunction-Max-Query"><a href="#單字符串多字段查詢：Disjunction-Max-Query" class="headerlink" title="單字符串多字段查詢：Disjunction Max Query"></a>單字符串多字段查詢：Disjunction Max Query</h1><p>一般在進行 single string multiple field 的查詢時，預設的分數計算方式過於簡單，往往會出現非使用者所預期的情況，例如以下範例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">DELETE blogs</span><br><span class="line"></span><br><span class="line"><span class="comment">//新增多筆資料</span></span><br><span class="line">POST /blogs/_bulk</span><br><span class="line">&#123; <span class="attr">"index"</span>: &#123; <span class="attr">"_id"</span>: <span class="number">1</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"title"</span>: <span class="string">"Quick brown rabbits"</span>, <span class="attr">"body"</span>:  <span class="string">"Brown rabbits are commonly seen."</span> &#125;</span><br><span class="line">&#123; <span class="attr">"index"</span>: &#123; <span class="attr">"_id"</span>: <span class="number">2</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"title"</span>: <span class="string">"Keeping pets healthy"</span>, <span class="attr">"body"</span>:  <span class="string">"My quick brown fox eats rabbits on a regular basis."</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//預期應該會是 id=2 的 document 相關性比較高</span></span><br><span class="line"><span class="comment">//但結果卻是 id=1 的相關度較高</span></span><br><span class="line"><span class="comment">//因為 id=1 的 document 在 title &amp; body 都有 brown</span></span><br><span class="line">POST /blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"bool"</span>: &#123;</span><br><span class="line">      <span class="attr">"should"</span>: [</span><br><span class="line">        &#123; <span class="attr">"match"</span>: &#123; <span class="attr">"title"</span>: <span class="string">"Brown fox"</span> &#125;&#125;,</span><br><span class="line">        &#123; <span class="attr">"match"</span>: &#123; <span class="attr">"body"</span>:  <span class="string">"Brown fox"</span> &#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//改用 dis_max 後，會綜合判斷所有符合 document 的分數 &amp; 相關 field</span></span><br><span class="line"><span class="comment">//找到最符合的評分後再返回</span></span><br><span class="line"><span class="comment">//因此 id=2 的 document 符合程度較高，就會被排在前面</span></span><br><span class="line">POST /blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"dis_max"</span>: &#123;</span><br><span class="line">      <span class="attr">"queries"</span>: [</span><br><span class="line">        &#123; <span class="attr">"match"</span>: &#123; <span class="attr">"title"</span>: <span class="string">"Brown fox"</span> &#125;&#125;,</span><br><span class="line">        &#123; <span class="attr">"match"</span>: &#123; <span class="attr">"body"</span>:  <span class="string">"Brown fox"</span> &#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此從上面的範例來看，透過 <strong>Disjunction Max Query</strong> 可以找到最符合查詢條件的結果。</p>
<p>但 Disjunction Max Query 也並非萬靈丹，因為其算分方式也是有盲點的，例如以下範例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用 Disjunction Max Query，會讓以下搜尋結果的分數都相同</span></span><br><span class="line">POST blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"dis_max"</span>: &#123;</span><br><span class="line">      <span class="attr">"queries"</span>: [</span><br><span class="line">        &#123; <span class="attr">"match"</span>: &#123; <span class="attr">"title"</span>: <span class="string">"Quick pets"</span> &#125;&#125;,</span><br><span class="line">        &#123; <span class="attr">"match"</span>: &#123; <span class="attr">"body"</span>:  <span class="string">"Quick pets"</span> &#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//透過加上 tie_breaker 的方式，改變計算分數的方法</span></span><br><span class="line"><span class="comment">//讓實際出現較多查詢條件的 document 取得較高的算分</span></span><br><span class="line">POST blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"dis_max"</span>: &#123;</span><br><span class="line">      <span class="attr">"queries"</span>: [</span><br><span class="line">        &#123; <span class="attr">"match"</span>: &#123; <span class="attr">"title"</span>: <span class="string">"Quick pets"</span> &#125;&#125;,</span><br><span class="line">        &#123; <span class="attr">"match"</span>: &#123; <span class="attr">"body"</span>:  <span class="string">"Quick pets"</span> &#125;&#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"tie_breaker"</span>: <span class="number">0.2</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>關於 <code>Disjunction Max Query</code> &amp; <code>tie_breaker</code> 的搭配，可以參考<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-dis-max-query.html" target="_blank" rel="noopener">官方文件</a>說明。</p>
<h1 id="單字符串多字段查詢：Multi-Match"><a href="#單字符串多字段查詢：Multi-Match" class="headerlink" title="單字符串多字段查詢：Multi Match"></a>單字符串多字段查詢：Multi Match</h1><p>一般 single string multiple field 的查詢，會發生在三個場景：</p>
<ul>
<li><code>Best Field</code> (預設 type)</li>
</ul>
<blockquote>
<p>每個 field 之間會互相競爭，搜尋時會把評分最高的 field 中的資料回傳(可以額外加上 <code>tie_breaker</code> or <code>minumum_should_match</code> 來調整搜尋精準度)</p>
</blockquote>
<ul>
<li><code>Most Field</code></li>
</ul>
<blockquote>
<p>通常會使用在英文的內容時，通常會在 main field 中設定 English Analyzer，並加入同義詞來試圖符合更多的 document，並適時的 text 中加入 sub field 搭配 standard Analyzer 盡量保留原始訊息，以提供更精確的搜尋結果</p>
</blockquote>
<ul>
<li><code>Cross Field</code></li>
</ul>
<blockquote>
<p>某些訊息需要同時在多個 field 查詢時，可以做一種類似多(single string -&gt; multi words)對多(multi field)的搜尋</p>
</blockquote>
<p>首先使用以下幾個範例來說明 <strong>Best Field</strong>：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">DELETE blogs</span><br><span class="line"></span><br><span class="line"><span class="comment">//新增多筆資料</span></span><br><span class="line">POST /blogs/_bulk</span><br><span class="line">&#123; <span class="attr">"index"</span>: &#123; <span class="attr">"_id"</span>: <span class="number">1</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"title"</span>: <span class="string">"Quick brown rabbits"</span>, <span class="attr">"body"</span>:  <span class="string">"Brown rabbits are commonly seen."</span> &#125;</span><br><span class="line">&#123; <span class="attr">"index"</span>: &#123; <span class="attr">"_id"</span>: <span class="number">2</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"title"</span>: <span class="string">"Keeping pets healthy"</span>, <span class="attr">"body"</span>:  <span class="string">"My quick brown fox eats rabbits on a regular basis."</span> &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//Disjunction Max Query 搜尋的盲點</span></span><br><span class="line"><span class="comment">//兩個 document 都會取得相同的分數</span></span><br><span class="line">POST blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"dis_max"</span>: &#123;</span><br><span class="line">      <span class="comment">//"tie_breaker": 0.2,</span></span><br><span class="line">      <span class="attr">"queries"</span>: [</span><br><span class="line">        &#123; <span class="attr">"match"</span>: &#123; <span class="attr">"title"</span>: <span class="string">"Quick pets"</span> &#125;&#125;,</span><br><span class="line">        &#123; <span class="attr">"match"</span>: &#123; <span class="attr">"body"</span>:  <span class="string">"Quick pets"</span> &#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//multi_match 卻沒搭配 tie_break or minimum_should_match</span></span><br><span class="line"><span class="comment">//效果跟 dis_max 是相同的</span></span><br><span class="line"><span class="comment">//但適時的加上 tie_break or minimum_should_match 可以提高搜尋的準確度</span></span><br><span class="line">POST blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"multi_match"</span>: &#123;</span><br><span class="line">      <span class="comment">//"tie_breaker": 0.2,</span></span><br><span class="line">      <span class="comment">//"minimum_should_match": "20%", </span></span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"best_fields"</span>,</span><br><span class="line">      <span class="attr">"query"</span>: <span class="string">"Quick pets"</span>,</span><br><span class="line">      <span class="attr">"fields"</span>: [<span class="string">"title"</span>,<span class="string">"body"</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">DELETE titles</span><br><span class="line"></span><br><span class="line"><span class="comment">//設定 analyzer 為 english</span></span><br><span class="line">PUT /titles</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"mappings"</span>: &#123;</span><br><span class="line">    <span class="attr">"properties"</span>: &#123;</span><br><span class="line">      <span class="attr">"title"</span>: &#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"text"</span>,</span><br><span class="line">        <span class="attr">"analyzer"</span>: <span class="string">"english"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//新增多筆資料</span></span><br><span class="line">POST titles/_bulk</span><br><span class="line">&#123; <span class="attr">"index"</span>: &#123; <span class="attr">"_id"</span>: <span class="number">1</span> &#125;&#125;</span><br><span class="line">&#123; <span class="attr">"title"</span>: <span class="string">"My dog barks"</span> &#125;</span><br><span class="line">&#123; <span class="attr">"index"</span>: &#123; <span class="attr">"_id"</span>: <span class="number">2</span> &#125;&#125;</span><br><span class="line">&#123; <span class="attr">"title"</span>: <span class="string">"I see a lot of barking dogs on the road "</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//搜尋結果跟預期不同</span></span><br><span class="line"><span class="comment">//由於 english analyzer 會將 barking dogs 分詞成 bark &amp; dog 兩個字</span></span><br><span class="line"><span class="comment">//因此上面兩個 document 計算出的分數都是相同的</span></span><br><span class="line">GET titles/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"match"</span>: &#123;</span><br><span class="line">      <span class="attr">"title"</span>: <span class="string">"barking dogs"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>從上面可以看出 best field 在某些時候的確會有一些盲點，因此我們可以試著使用以下方法來調整：</p>
<ul>
<li><p>額外增加一個 <code>std</code> field，並使用 standard analyzer</p>
</li>
<li><p>將 <strong>query.multi_match.type</strong> 改成 <code>most_fields</code></p>
</li>
</ul>
<blockquote>
<p>也可以根據需求適時加入 boosting 設定</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">DELETE /titles</span><br><span class="line"></span><br><span class="line"><span class="comment">//額外增加一個 "std" field，並使用 standard analyzer</span></span><br><span class="line">PUT /titles</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"mappings"</span>: &#123;</span><br><span class="line">    <span class="attr">"properties"</span>: &#123;</span><br><span class="line">      <span class="attr">"title"</span>: &#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"text"</span>,</span><br><span class="line">        <span class="attr">"analyzer"</span>: <span class="string">"english"</span>,</span><br><span class="line">        <span class="attr">"fields"</span>: &#123;<span class="attr">"std"</span>: &#123;<span class="attr">"type"</span>: <span class="string">"text"</span>,<span class="attr">"analyzer"</span>: <span class="string">"standard"</span>&#125;&#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//新增資料</span></span><br><span class="line">POST titles/_bulk</span><br><span class="line">&#123; <span class="attr">"index"</span>: &#123; <span class="attr">"_id"</span>: <span class="number">1</span> &#125;&#125;</span><br><span class="line">&#123; <span class="attr">"title"</span>: <span class="string">"My dog barks"</span> &#125;</span><br><span class="line">&#123; <span class="attr">"index"</span>: &#123; <span class="attr">"_id"</span>: <span class="number">2</span> &#125;&#125;</span><br><span class="line">&#123; <span class="attr">"title"</span>: <span class="string">"I see a lot of barking dogs on the road "</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//將 query.multi_match.type 改成 "most_fields"</span></span><br><span class="line">GET /titles/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"multi_match"</span>: &#123;</span><br><span class="line">      <span class="attr">"query"</span>:  <span class="string">"barking dogs"</span>,</span><br><span class="line">      <span class="attr">"type"</span>:   <span class="string">"most_fields"</span>,</span><br><span class="line">      <span class="attr">"fields"</span>: [ <span class="string">"title"</span>, <span class="string">"title.std"</span> ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//也可以根據需要加入 boosting 的設定(範例中的 ^10 就是)</span></span><br><span class="line">GET /titles/_search</span><br><span class="line">&#123;</span><br><span class="line">   <span class="attr">"query"</span>: &#123;</span><br><span class="line">        <span class="attr">"multi_match"</span>: &#123;</span><br><span class="line">            <span class="attr">"query"</span>:  <span class="string">"barking dogs"</span>,</span><br><span class="line">            <span class="attr">"type"</span>:   <span class="string">"most_fields"</span>,</span><br><span class="line">            <span class="attr">"fields"</span>: [ <span class="string">"title^10"</span>, <span class="string">"title.std"</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接著如果我們需要針對更複雜的資料(例如：地址)，並同時在多個 field 中做搜尋，則可以藉由 <code>cross_fields</code> 來取得更精確的搜尋結果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//新增一筆地址資料</span></span><br><span class="line">PUT address/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"street"</span>: <span class="string">"5 Poland Street"</span>, </span><br><span class="line">  <span class="attr">"city"</span>: <span class="string">"London"</span>, </span><br><span class="line">  <span class="attr">"country"</span>: <span class="string">"United Kingdom"</span>, </span><br><span class="line">  <span class="attr">"postcode"</span>: <span class="string">"W1V 3DG"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//透過 cross_field" 進行 multi field 資料搜尋</span></span><br><span class="line"><span class="comment">//若是 type 改為 "most_fields" 搭配 AND operator 就會找不到資料</span></span><br><span class="line">POST address/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"multi_match"</span>: &#123;</span><br><span class="line">      <span class="attr">"query"</span>: <span class="string">"Poland Kingdom W1V"</span>,</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"cross_fields"</span>, </span><br><span class="line">      <span class="attr">"operator"</span>: <span class="string">"and"</span>,</span><br><span class="line">      <span class="attr">"fields"</span>: [<span class="string">"street"</span>, <span class="string">"city"</span>, <span class="string">"country"</span>, <span class="string">"postcode"</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="全文檢索案例"><a href="#全文檢索案例" class="headerlink" title="全文檢索案例"></a>全文檢索案例</h1><h2 id="思考-amp-分析"><a href="#思考-amp-分析" class="headerlink" title="思考 &amp; 分析"></a>思考 &amp; 分析</h2><ul>
<li><p><code>Full text query</code> or <code>Term query</code></p>
</li>
<li><p>針對搜尋的條件 &amp; field，定義合適的 analyzer 是很重要的</p>
</li>
<li><p>開發時需要對不同的 analyzer 做測試</p>
</li>
<li><p>透過調整 mapping 設定，並改寫搜尋條件，來交叉評估不同的搜尋結果以取得期望的結果</p>
</li>
</ul>
<h2 id="相關性測試"><a href="#相關性測試" class="headerlink" title="相關性測試"></a>相關性測試</h2><ul>
<li><p>相關性測試並非簡單工作，必須了解原理 &amp; 多做分析 &amp; 多做調整</p>
</li>
<li><p>可能會需要多 analyzer &amp; boosting … 等參數做各式各樣的調整</p>
</li>
<li><p>每個環境跟需求對應到的設定 &amp; 搜尋條件也都不會相同，不會有 silver bullet 般的設定可以一次解決所有問題</p>
</li>
</ul>
<h2 id="監控-amp-理解用戶行為"><a href="#監控-amp-理解用戶行為" class="headerlink" title="監控 &amp; 理解用戶行為"></a>監控 &amp; 理解用戶行為</h2><ul>
<li><p>相關性測試其實是最後一步，不要進行過度的相關性測試是很重要的</p>
</li>
<li><p>必須嘗試監控用戶的搜尋結果，並試著理解使用者的使用行為</p>
<ul>
<li><p>例如：在後台實作功能，查詢使用者的哪些查詢是沒有回傳任何結果的</p>
</li>
<li><p>衡量使用者對於實際搜尋結果的點擊率</p>
</li>
</ul>
</li>
</ul>
<h1 id="使用-Search-Template-和-Index-Alias-查詢"><a href="#使用-Search-Template-和-Index-Alias-查詢" class="headerlink" title="使用 Search Template 和 Index Alias 查詢"></a>使用 Search Template 和 Index Alias 查詢</h1><h2 id="Search-Template"><a href="#Search-Template" class="headerlink" title="Search Template"></a>Search Template</h2><ul>
<li><p>主要的功能在於 de-couple <code>程式</code>與<code>查詢用的 DSL</code> 兩者之間的關係，讓專業的工程師可以各司其職的完成工作(開發人員/查詢工程師/效能調校工程師)</p>
</li>
<li><p>程式設計師不需要了解查詢的優化細節，只要使用 ES 工程師提供的 Search Template 即可</p>
</li>
<li><p>ES 工程師則可以專注在效能的調校 &amp; 優化 search template 工作上</p>
</li>
</ul>
<p>以下是一個簡單範例：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//新增 search template</span></span><br><span class="line">POST _scripts/tmdb</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"script"</span>: &#123;</span><br><span class="line">    <span class="attr">"lang"</span>: <span class="string">"mustache"</span>,</span><br><span class="line">    <span class="attr">"source"</span>: &#123;</span><br><span class="line">      <span class="attr">"_source"</span>: [</span><br><span class="line">        <span class="string">"title"</span>,<span class="string">"overview"</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"size"</span>: <span class="number">20</span>,</span><br><span class="line">      <span class="attr">"query"</span>: &#123;</span><br><span class="line">        <span class="attr">"multi_match"</span>: &#123;</span><br><span class="line">          <span class="attr">"query"</span>: <span class="string">"&#123;&#123;q&#125;&#125;"</span>,</span><br><span class="line">          <span class="attr">"fields"</span>: [<span class="string">"title"</span>,<span class="string">"overview"</span>]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//檢視 search index 的內容</span></span><br><span class="line">GET _scripts/tmdb</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用 search template 查詢，帶入預先定義的參數 q</span></span><br><span class="line">POST tmdb/_search/template</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"id"</span>:<span class="string">"tmdb"</span>,</span><br><span class="line">    <span class="attr">"params"</span>: &#123;</span><br><span class="line">        <span class="attr">"q"</span>: <span class="string">"basketball with cartoon aliens"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//刪除 search template</span></span><br><span class="line">DELETE _scripts/tmdb</span><br></pre></td></tr></table></figure>
<h2 id="Index-Alias"><a href="#Index-Alias" class="headerlink" title="Index Alias"></a>Index Alias</h2><p><code>index alias</code> 就跟 Linux 中的 <code>alias</code> 指令一樣，是作為設定別名的用途。</p>
<p>而通常為 index 設定別名是有其需要的，例如每天建立一個新的 index，但在程式中每天都根據日期去產生一個字串來作為 index 來查詢，其實挺麻煩的；此時透過設定一個名稱為 <strong>latest_index</strong> 並指到每天最新的 index 的方式，問題就迎刃而解了。</p>
<p>以下是一個簡單範例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">PUT movies-2019/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>:<span class="string">"the matrix"</span>,</span><br><span class="line">  <span class="attr">"rating"</span>:<span class="number">5</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT movies-2019/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>:<span class="string">"Speed"</span>,</span><br><span class="line">  <span class="attr">"rating"</span>:<span class="number">3</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//建立 index alias</span></span><br><span class="line">POST _aliases</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"actions"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"add"</span>: &#123;</span><br><span class="line">        <span class="attr">"index"</span>: <span class="string">"movies-2019"</span>,</span><br><span class="line">        <span class="attr">"alias"</span>: <span class="string">"movies-latest"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//對 index alias 進行查詢</span></span><br><span class="line">POST movies-latest/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"match_all"</span>: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//另外建立一個 index alias</span></span><br><span class="line">POST _aliases</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"actions"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"add"</span>: &#123;</span><br><span class="line">        <span class="attr">"index"</span>: <span class="string">"movies-2019"</span>,</span><br><span class="line">        <span class="attr">"alias"</span>: <span class="string">"movies-lastest-highrate"</span>,</span><br><span class="line">        <span class="comment">//index alias 設定中還可以額外設定 filter </span></span><br><span class="line">        <span class="attr">"filter"</span>: &#123;</span><br><span class="line">          <span class="attr">"range"</span>: &#123;</span><br><span class="line">            <span class="attr">"rating"</span>: &#123;</span><br><span class="line">              <span class="attr">"gte"</span>: <span class="number">4</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//對 index alias 進行查詢</span></span><br><span class="line">POST movies-lastest-highrate/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"match_all"</span>: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="綜合排序：Function-Score-Query-優化算分"><a href="#綜合排序：Function-Score-Query-優化算分" class="headerlink" title="綜合排序：Function Score Query 優化算分"></a>綜合排序：Function Score Query 優化算分</h1><h2 id="Scoring-amp-Sorting"><a href="#Scoring-amp-Sorting" class="headerlink" title="Scoring &amp; Sorting"></a>Scoring &amp; Sorting</h2><ul>
<li><p>Elasticsearch 預設會以 document 的相關度算分進行排序</p>
</li>
<li><p>可以指定一個 or 多個 field 進行排序</p>
</li>
<li><p>但預設情況下，無法對相關度 or 排序進行更多細部的控制調整</p>
</li>
</ul>
<h2 id="Function-Score-Query"><a href="#Function-Score-Query" class="headerlink" title="Function Score Query"></a>Function Score Query</h2><p>可以在查詢結束後，對每一個符合的 document 進行重新算分，並根據新的分數來進行排序。</p>
<p>Elasticsearch 中已經包含了以下幾種用來算分的函數：(非全部，比較常用的，詳細資訊可參考<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html" target="_blank" rel="noopener">官網</a>)</p>
<ul>
<li><p><code>Weight</code>：為每一個 document 設定一個簡單不被規範化的權重</p>
</li>
<li><p><code>Field Value Factor</code>：可指定特定的 field 來影響算分過程，例如指定<strong>點讚數</strong>作為算分的條件之一</p>
</li>
<li><p><code>Random Score</code>：隨機算分</p>
</li>
<li><p><code>Decay Function</code>：以某個 field 的值作為基準，距離越遠得分越高</p>
</li>
<li><p><code>Script Score</code>：自己寫 script 來自定算分邏輯</p>
</li>
</ul>
<p>以下用一個實際範例來說明使用方法：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">DELETE blogs</span><br><span class="line"></span><br><span class="line"><span class="comment">//加入三筆一模一樣的資料到 blogs index</span></span><br><span class="line"><span class="comment">//唯一的差別只有 votes 數量而已</span></span><br><span class="line"><span class="comment">//若使用預設的 BM25 進行算分，三個 document 會得到相同分數</span></span><br><span class="line">PUT /blogs/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"title"</span>:   <span class="string">"About popularity"</span>,</span><br><span class="line">  <span class="attr">"content"</span>: <span class="string">"In this post we will talk about..."</span>,</span><br><span class="line">  <span class="attr">"votes"</span>:   <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line">PUT /blogs/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"title"</span>:   <span class="string">"About popularity"</span>,</span><br><span class="line">  <span class="attr">"content"</span>: <span class="string">"In this post we will talk about..."</span>,</span><br><span class="line">  <span class="attr">"votes"</span>:   <span class="number">100</span></span><br><span class="line">&#125;</span><br><span class="line">PUT /blogs/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"title"</span>:   <span class="string">"About popularity"</span>,</span><br><span class="line">  <span class="attr">"content"</span>: <span class="string">"In this post we will talk about..."</span>,</span><br><span class="line">  <span class="attr">"votes"</span>:   <span class="number">1000000</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用 function score query，搭配 field_value_factor 來指定重要的 field</span></span><br><span class="line"><span class="comment">//但會發現 votes 值超高的 document 會取得超高的分數</span></span><br><span class="line">POST /blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"function_score"</span>: &#123;</span><br><span class="line">      <span class="attr">"query"</span>: &#123;</span><br><span class="line">        <span class="attr">"multi_match"</span>: &#123;</span><br><span class="line">          <span class="attr">"query"</span>:    <span class="string">"popularity"</span>,</span><br><span class="line">          <span class="attr">"fields"</span>: [ <span class="string">"title"</span>, <span class="string">"content"</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"field_value_factor"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"votes"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//因此除了 field_value_factor 之外</span></span><br><span class="line"><span class="comment">//可以額外設定 modifier = log1p 來進行平滑曲線設定</span></span><br><span class="line"><span class="comment">//new score = old score * log(1 + votes)</span></span><br><span class="line">POST /blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"function_score"</span>: &#123;</span><br><span class="line">      <span class="attr">"query"</span>: &#123;</span><br><span class="line">        <span class="attr">"multi_match"</span>: &#123;</span><br><span class="line">          <span class="attr">"query"</span>:    <span class="string">"popularity"</span>,</span><br><span class="line">          <span class="attr">"fields"</span>: [ <span class="string">"title"</span>, <span class="string">"content"</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"field_value_factor"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"votes"</span>,</span><br><span class="line">        <span class="attr">"modifier"</span>: <span class="string">"log1p"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//除了 modifier 之外，還可以額外增加 factor 對平滑曲線做更細膩的控制</span></span><br><span class="line"><span class="comment">//new score = old score * log(1 + factor * votes)</span></span><br><span class="line">POST /blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"function_score"</span>: &#123;</span><br><span class="line">      <span class="attr">"query"</span>: &#123;</span><br><span class="line">        <span class="attr">"multi_match"</span>: &#123;</span><br><span class="line">          <span class="attr">"query"</span>:    <span class="string">"popularity"</span>,</span><br><span class="line">          <span class="attr">"fields"</span>: [ <span class="string">"title"</span>, <span class="string">"content"</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"field_value_factor"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"votes"</span>,</span><br><span class="line">        <span class="attr">"modifier"</span>: <span class="string">"log1p"</span> ,</span><br><span class="line">        <span class="attr">"factor"</span>: <span class="number">0.1</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Boost-Mode-amp-Max-Boost"><a href="#Boost-Mode-amp-Max-Boost" class="headerlink" title="Boost Mode &amp; Max Boost"></a>Boost Mode &amp; Max Boost</h2><p>在 function score query 中同樣也可以加入 boost 的設定，並可以搭配多種不同的 boost mode 來調整計算分數時的基礎：</p>
<ul>
<li><p><code>multiply</code>: query score 與 function score 相乘(預設值)</p>
</li>
<li><p><code>replace</code>: 忽略 query score，只使用 function score</p>
</li>
<li><p><code>sum</code>: query score 與 function score 相加</p>
</li>
<li><p><code>avg</code>: query score 與 function score 的平均值</p>
</li>
<li><p><code>max</code>: query score 與 function score 兩者中較大的值</p>
</li>
<li><p><code>min</code>: query score 與 function score 兩者中較小的值</p>
</li>
</ul>
<p>以下是個簡單範例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">POST /blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"function_score"</span>: &#123;</span><br><span class="line">      <span class="attr">"query"</span>: &#123;</span><br><span class="line">        <span class="attr">"multi_match"</span>: &#123;</span><br><span class="line">          <span class="attr">"query"</span>:    <span class="string">"popularity"</span>,</span><br><span class="line">          <span class="attr">"fields"</span>: [ <span class="string">"title"</span>, <span class="string">"content"</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">//使用 function score query，搭配 log1p &amp; factor 的設定來做平滑曲線的處理</span></span><br><span class="line">      <span class="attr">"field_value_factor"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"votes"</span>,</span><br><span class="line">        <span class="attr">"modifier"</span>: <span class="string">"log1p"</span> ,</span><br><span class="line">        <span class="attr">"factor"</span>: <span class="number">0.1</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">//還可以額外設定 boost mode &amp; max_boost 來進行搜尋的調校</span></span><br><span class="line">      <span class="attr">"boost_mode"</span>: <span class="string">"sum"</span>,</span><br><span class="line">      <span class="attr">"max_boost"</span>: <span class="number">3</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="一致性的隨機函數"><a href="#一致性的隨機函數" class="headerlink" title="一致性的隨機函數"></a>一致性的隨機函數</h2><ul>
<li><p>當網站上的廣告需要提高曝光率，又不想要亂槍打鳥時 (希望每個使用者進來看到的廣告是相同的)</p>
</li>
<li><p>透過一致性的隨機函數可以讓每個用戶看到不同的隨機排名，但同一個用戶每一次的 request 都會得到一致的回應</p>
</li>
</ul>
<p>以上的需求就可以透過 function score query 中的 <code>Random Score</code> 來達成：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//以隨機但一致的方式進行算分(透過 seed 參數控制)</span></span><br><span class="line">POST /blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"function_score"</span>: &#123;</span><br><span class="line">      <span class="attr">"random_score"</span>: &#123;</span><br><span class="line">        <span class="attr">"seed"</span>: <span class="number">911119</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Term-amp-Phrase-Suggester"><a href="#Term-amp-Phrase-Suggester" class="headerlink" title="Term &amp; Phrase Suggester"></a>Term &amp; Phrase Suggester</h1><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-suggesters.html" target="_blank" rel="noopener">Elastic 官網文件 - Suggester</a></p>
<h2 id="什麼是搜尋建議"><a href="#什麼是搜尋建議" class="headerlink" title="什麼是搜尋建議?"></a>什麼是搜尋建議?</h2><ul>
<li><p>搜尋建議是現代化搜尋引擎常見的功能</p>
</li>
<li><p>用途是在幫助使用者在輸入搜尋內容的過程中，協助補完搜尋內容，或是進行錯誤的偵測，當然也可以推薦用戶符合更多搜尋條件的建議，因此這樣的作法同樣也可以提高搜尋時找到合適結果的機率</p>
</li>
</ul>
<h2 id="Elasticsearch-Suggester-API"><a href="#Elasticsearch-Suggester-API" class="headerlink" title="Elasticsearch Suggester API"></a>Elasticsearch Suggester API</h2><ul>
<li><p>搜尋建議的功能在 Elasticsearch 中是透過 Suggester API 來實現的</p>
</li>
<li><p>而運作的原理在於將輸入的內容分解為 token，接著在索引的字典裡面尋找相似的 term 並回傳</p>
</li>
<li><p>目前 Elasticsearch 一共支援四種 suggester，分別是 <code>Term</code>, <code>Phrase</code>, <code>Complete</code>, <code>Context</code> 四種</p>
</li>
<li><p>每個 sueggester 中還可以額外設定好幾個 suggestion mode，分別是：</p>
<ul>
<li><p><code>Missing</code>: 如果索引中已經存在，就不提供建議 (表示使用者已經輸入正確的內容)</p>
</li>
<li><p><code>Popular</code>: 推薦出現頻率比較高的詞</p>
</li>
<li><p><code>Always</code>: 無論是否存在，都提供建議</p>
</li>
</ul>
</li>
</ul>
<p>以下是幾個簡單範例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">DELETE articles</span><br><span class="line"></span><br><span class="line"><span class="comment">//在 index 中新增多筆資料</span></span><br><span class="line">POST articles/_bulk</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123; &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"body"</span>: <span class="string">"lucene is very cool"</span>&#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123; &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"body"</span>: <span class="string">"Elasticsearch builds on top of lucene"</span>&#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123; &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"body"</span>: <span class="string">"Elasticsearch rocks"</span>&#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123; &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"body"</span>: <span class="string">"elastic is the company behind ELK stack"</span>&#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123; &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"body"</span>: <span class="string">"Elk stack rocks"</span>&#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;&#125; &#125;</span><br><span class="line">&#123;  <span class="attr">"body"</span>: <span class="string">"elasticsearch is rock solid"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//進行 term suggestion</span></span><br><span class="line"><span class="comment">//透過檢查 response 中的 "suggest" 區段內容</span></span><br><span class="line"><span class="comment">//可以發現 "lucen" 取得了 "lucene" 的建議</span></span><br><span class="line"><span class="comment">//而 rock 就沒有了，因為 suggest mode 設定為 missing 的關係</span></span><br><span class="line">POST /articles/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"match"</span>: &#123;</span><br><span class="line">      <span class="attr">"body"</span>: <span class="string">"lucen rock"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"suggest"</span>: &#123;</span><br><span class="line">    <span class="attr">"term-suggestion"</span>: &#123;</span><br><span class="line">      <span class="attr">"text"</span>: <span class="string">"lucen rock"</span>,</span><br><span class="line">      <span class="attr">"term"</span>: &#123;</span><br><span class="line">        <span class="attr">"suggest_mode"</span>: <span class="string">"missing"</span>,</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"body"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//同樣的 suggest 搜尋，但搭配 suggestion mode 為 "popular"</span></span><br><span class="line"><span class="comment">//此時 rock 就會出現了</span></span><br><span class="line">POST /articles/_search</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  <span class="attr">"suggest"</span>: &#123;</span><br><span class="line">    <span class="attr">"term-suggestion"</span>: &#123;</span><br><span class="line">      <span class="attr">"text"</span>: <span class="string">"lucen rock"</span>,</span><br><span class="line">      <span class="attr">"term"</span>: &#123;</span><br><span class="line">        <span class="attr">"suggest_mode"</span>: <span class="string">"popular"</span>,</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"body"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>每個回傳的 suggest 都包含了一個算分，這也代表著相似性(相似性越高，分數越高)，相似性是由 <strong>LEvenshtein Edit Distance</strong> 的計算方法來實作出來的，核心概念就是 <code>一個詞變更了多少字元就可以和另外一個詞一致</code>。</p>
<p>而相似性的設定部份也可以透過一些參數可以來控制，例如 <code>max_edits</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//若是打錯字(範例中的 hocks)，也是可以可以取得搜尋建議</span></span><br><span class="line"><span class="comment">//但是必須要把 prefix_length 那行設定打開</span></span><br><span class="line"><span class="comment">//prefix_length 的功能如下：</span></span><br><span class="line"><span class="comment">// The number of minimal prefix characters that must match in order be a candidate for suggestions. Defaults to 1. Increasing this number improves spellcheck performance. Usually misspellings don’t occur in the beginning of terms. (Old name "prefix_len" is deprecated)</span></span><br><span class="line">POST /articles/_search</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  <span class="attr">"suggest"</span>: &#123;</span><br><span class="line">    <span class="attr">"term-suggestion"</span>: &#123;</span><br><span class="line">      <span class="attr">"text"</span>: <span class="string">"lucen hocks"</span>,</span><br><span class="line">      <span class="attr">"term"</span>: &#123;</span><br><span class="line">        <span class="attr">"suggest_mode"</span>: <span class="string">"always"</span>,</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"body"</span>,</span><br><span class="line">        <span class="comment">//"prefix_length":0,</span></span><br><span class="line">        <span class="attr">"sort"</span>: <span class="string">"frequency"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//一個很簡單的 phrase suggester 的範例</span></span><br><span class="line">POST /articles/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"suggest"</span>: &#123;</span><br><span class="line">    <span class="attr">"my-suggestion"</span>: &#123;</span><br><span class="line">      <span class="attr">"text"</span>: <span class="string">"lucne and elasticsear rock hello world "</span>,</span><br><span class="line">      <span class="comment">//要改成 phrase suggester，只要在這裡從 "term" 改為 "phrase" 即可</span></span><br><span class="line">      <span class="attr">"phrase"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"body"</span>,</span><br><span class="line">        <span class="comment">//相較於 term suggester，還額外支援了不少的搜尋參數</span></span><br><span class="line">        <span class="comment">//稍微調整一下兩個參數的值就可以看出會有些不同</span></span><br><span class="line">        <span class="attr">"max_errors"</span>:<span class="number">2</span>,</span><br><span class="line">        <span class="attr">"confidence"</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="attr">"direct_generator"</span>:[&#123;</span><br><span class="line">          <span class="attr">"field"</span>:<span class="string">"body"</span>,</span><br><span class="line">          <span class="attr">"suggest_mode"</span>:<span class="string">"always"</span></span><br><span class="line">        &#125;],</span><br><span class="line">        <span class="attr">"highlight"</span>: &#123;</span><br><span class="line">          <span class="attr">"pre_tag"</span>: <span class="string">"&lt;em&gt;"</span>,</span><br><span class="line">          <span class="attr">"post_tag"</span>: <span class="string">"&lt;/em&gt;"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Completion-amp-Context-Suggester"><a href="#Completion-amp-Context-Suggester" class="headerlink" title="Completion &amp; Context Suggester"></a>Completion &amp; Context Suggester</h1><h2 id="Completion-Suggester"><a href="#Completion-Suggester" class="headerlink" title="Completion Suggester"></a>Completion Suggester</h2><ul>
<li><p>Completion Suggester 提供 auto complete 的功能，因此使用者每輸入一個字，就需要即時發送一個查詢到後端來搜尋符合項目</p>
</li>
<li><p>承上，這樣的行為對效能的要求就會相對嚴格；而 Elasticsearch 本身則採用了不同的數據結構來實現這個需求，將 analyzer 處理過後的數據編碼成 FST 和索引一起存放，而整個 FST 會被放到記憶體中，因此存取相對快很多</p>
</li>
<li><p>但 FST 只能進行 prefix 的搜尋</p>
</li>
</ul>
<p>要使用 completion suggester，就必須要在 index mapping 的設定中進行相關設定：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PUT articles</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"mappings"</span>: &#123;</span><br><span class="line">    <span class="attr">"properties"</span>: &#123;</span><br><span class="line">      <span class="attr">"title_completion"</span>:&#123;</span><br><span class="line">        <span class="comment">//需要將 type 設定為 completion</span></span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"completion"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以下是實際的操作範例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//新增資料</span></span><br><span class="line">POST articles/_bulk</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123; &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"title_completion"</span>: <span class="string">"lucene is very cool"</span>&#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123; &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"title_completion"</span>: <span class="string">"Elasticsearch builds on top of lucene"</span>&#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123; &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"title_completion"</span>: <span class="string">"Elasticsearch rocks"</span>&#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123; &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"title_completion"</span>: <span class="string">"elastic is the company behind ELK stack"</span>&#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123; &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"title_completion"</span>: <span class="string">"Elk stack rocks"</span>&#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;&#125; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用 completion suggester</span></span><br><span class="line">POST articles/_search?pretty</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"suggest"</span>: &#123;</span><br><span class="line">    <span class="attr">"article-suggester"</span>: &#123;</span><br><span class="line">      <span class="attr">"prefix"</span>: <span class="string">"e "</span>,</span><br><span class="line">      <span class="comment">//也可以試試看</span></span><br><span class="line">      <span class="comment">//"prefix": "elk ",</span></span><br><span class="line">      <span class="attr">"completion"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"title_completion"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Context-Suggester"><a href="#Context-Suggester" class="headerlink" title="Context Suggester"></a>Context Suggester</h2><ul>
<li><p>Context Suggester 是由 ccompletion suggester 擴充而成的</p>
</li>
<li><p>可以在搜尋中加入更多上下文的訊息，例如輸入 “<strong>star</strong>“：</p>
<ul>
<li><p>若與咖啡相關：建議 “<strong>starbucks</strong>“</p>
</li>
<li><p>與電影相關：建議 “<strong>star wars</strong>“</p>
</li>
</ul>
</li>
</ul>
<h2 id="如何實作-Context-Suggester"><a href="#如何實作-Context-Suggester" class="headerlink" title="如何實作 Context Suggester ?"></a>如何實作 Context Suggester ?</h2><ul>
<li><p>可以定義兩種類型的 context</p>
<ul>
<li><p><code>Category</code>：任意的 string</p>
</li>
<li><p><code>Geo</code>：地理位置訊息</p>
</li>
</ul>
</li>
<li><p>實作 Context Suggester 的步驟：</p>
<ul>
<li><p>設定 mapping</p>
</li>
<li><p>將數據進行索引，並且為每個 document 加入 context 訊息</p>
</li>
<li><p>結合 context 進行 suggestion 查詢</p>
</li>
</ul>
</li>
</ul>
<p>以下是一個簡單的範例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">DELETE comments</span><br><span class="line"><span class="comment">//新增 index &amp; 設定 mapping</span></span><br><span class="line">PUT comments</span><br><span class="line">PUT comments/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"properties"</span>: &#123;</span><br><span class="line">    <span class="attr">"comment_autocomplete"</span>:&#123;</span><br><span class="line">      <span class="comment">//基於 completion suggester 擴充而來</span></span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"completion"</span>,</span><br><span class="line">      <span class="comment">//設定 context，指定類型為 category，並設定 context field "comment_category"</span></span><br><span class="line">      <span class="attr">"contexts"</span>:[&#123;</span><br><span class="line">        <span class="attr">"type"</span>:<span class="string">"category"</span>,</span><br><span class="line">        <span class="attr">"name"</span>:<span class="string">"comment_category"</span></span><br><span class="line">      &#125;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//新增 movie category 相關的 document</span></span><br><span class="line">POST comments/_doc</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"comment"</span>:<span class="string">"I love the star war movies"</span>,</span><br><span class="line">  <span class="attr">"comment_autocomplete"</span>:&#123;</span><br><span class="line">    <span class="attr">"input"</span>:[<span class="string">"star wars"</span>],</span><br><span class="line">    <span class="attr">"contexts"</span>:&#123;</span><br><span class="line">      <span class="attr">"comment_category"</span>:<span class="string">"movies"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//新增 coffee category 相關的 document</span></span><br><span class="line">POST comments/_doc</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"comment"</span>:<span class="string">"Where can I find a Starbucks"</span>,</span><br><span class="line">  <span class="attr">"comment_autocomplete"</span>:&#123;</span><br><span class="line">    <span class="attr">"input"</span>:[<span class="string">"starbucks"</span>],</span><br><span class="line">    <span class="attr">"contexts"</span>:&#123;</span><br><span class="line">      <span class="attr">"comment_category"</span>:<span class="string">"coffee"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//指定 category 來取得建議的關鍵字</span></span><br><span class="line">POST comments/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"suggest"</span>: &#123;</span><br><span class="line">    <span class="attr">"MY_SUGGESTION"</span>: &#123;</span><br><span class="line">      <span class="attr">"prefix"</span>: <span class="string">"sta"</span>,</span><br><span class="line">      <span class="attr">"completion"</span>:&#123;</span><br><span class="line">        <span class="attr">"field"</span>:<span class="string">"comment_autocomplete"</span>,</span><br><span class="line">        <span class="attr">"contexts"</span>:&#123;</span><br><span class="line">          <span class="attr">"comment_category"</span>:<span class="string">"coffee"</span></span><br><span class="line">          <span class="comment">//可以嘗試把 category 改成 movies 再試試看</span></span><br><span class="line">          <span class="comment">//"comment_category":"movies"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="關於-Precision-精準度-amp-Recall-招回率"><a href="#關於-Precision-精準度-amp-Recall-招回率" class="headerlink" title="關於 Precision(精準度) &amp; Recall(招回率)"></a>關於 Precision(精準度) &amp; Recall(招回率)</h2><p>以 <code>Precision(精準度)</code> 來看： (<strong>盡可能返回較少的無關 document</strong>)</p>
<blockquote>
<p>Completion &gt; Phrase &gt; Term</p>
</blockquote>
<p>以 <code>Recall(招回率)</code> 來看： (<strong>盡量返回較多的相關 document</strong>)</p>
<blockquote>
<p>Term &gt; Phrase &gt; Completion</p>
</blockquote>
<p>以 performance 來看：</p>
<blockquote>
<p>Completion &gt; Phrase &gt; Term</p>
</blockquote>
<h1 id="Cross-Cluster-Search"><a href="#Cross-Cluster-Search" class="headerlink" title="Cross Cluster Search"></a>Cross Cluster Search</h1><h2 id="水平擴展的問題"><a href="#水平擴展的問題" class="headerlink" title="水平擴展的問題"></a>水平擴展的問題</h2><ul>
<li>若只有 single cluster，水平擴展是不能無限增加節點數的</li>
</ul>
<blockquote>
<p>當 cluster metadata(node, index, cluster status) 過大時，會導致更新壓力變大，單一個 active master 會成為效能的瓶頸，導致整個 cluster 無法正常工作</p>
</blockquote>
<ul>
<li>以前透過 <strong>tribe node</strong> 實現 cross node search，但因為問題不少，因此 Elasticsearch 5.3 已經沒有使用 tribe node，而是改用 <code>Cross Cluster Search</code> 功能來取代</li>
</ul>
<h2 id="Cross-Cluster-Search-1"><a href="#Cross-Cluster-Search-1" class="headerlink" title="Cross Cluster Search"></a>Cross Cluster Search</h2><ul>
<li><p>允許任何節點扮演 federated node，以輕量的方式處理搜尋請求</p>
</li>
<li><p>不需要以 client node 的形式加入其他的 cluster</p>
</li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/blog/tags/Elasticsearch/" rel="tag"># Elasticsearch</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/blog/Elasticsearch/Elasticsearch-getting-started/" rel="next" title="[Elasticsearch] 基本概念 & 搜尋入門">
                <i class="fa fa-chevron-left"></i> [Elasticsearch] 基本概念 & 搜尋入門
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/blog/Linux/Linux-extend-lvm-from-unused-space/" rel="prev" title="[Linux] 利用未分割的硬碟空間，擴充 LVM 空間">
                [Linux] 利用未分割的硬碟空間，擴充 LVM 空間 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目錄
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            本站概覽
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">godleon</p>
              <p class="site-description motion-element" itemprop="description">把時間花在哪裡，成就就在哪裡</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/blog/archives/">
              
                  <span class="site-state-item-count">102</span>
                  <span class="site-state-item-name">文章</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/blog/categories/index.html">
                  <span class="site-state-item-count">19</span>
                  <span class="site-state-item-name">分類</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/blog/tags/index.html">
                  <span class="site-state-item-count">56</span>
                  <span class="site-state-item-name">標籤</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/godleon" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-globe"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:godleon@gmail.com" target="_blank" title="E-Mail">
                    
                      <i class="fa fa-fw fa-globe"></i>E-Mail</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://plus.google.com/godleon" target="_blank" title="Google">
                    
                      <i class="fa fa-fw fa-google"></i>Google</a>
                </span>
              
            
          </div>

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Conclusion"><span class="nav-number">1.</span> <span class="nav-text">Conclusion</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Term-Query-amp-Full-Text-Query"><span class="nav-number">2.</span> <span class="nav-text">Term Query &amp; Full Text Query</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Term-Query"><span class="nav-number">2.1.</span> <span class="nav-text">Term Query</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Full-Text-Query"><span class="nav-number">2.2.</span> <span class="nav-text">Full Text Query</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#結構化搜尋"><span class="nav-number">3.</span> <span class="nav-text">結構化搜尋</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#結構化數據"><span class="nav-number">3.1.</span> <span class="nav-text">結構化數據</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#搜索的相關性算分"><span class="nav-number">4.</span> <span class="nav-text">搜索的相關性算分</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#相關性-amp-相關性算分"><span class="nav-number">4.1.</span> <span class="nav-text">相關性 &amp; 相關性算分</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Term-Frequency-詞頻-amp-逆文檔頻率-Inverse-Document-Frequency-IDF"><span class="nav-number">4.2.</span> <span class="nav-text">Term Frequency (詞頻) &amp; 逆文檔頻率(Inverse Document Frequency, IDF)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BM-25"><span class="nav-number">4.3.</span> <span class="nav-text">BM 25</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Boosting-Relevance"><span class="nav-number">4.4.</span> <span class="nav-text">Boosting Relevance</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Query-amp-Filtering-與多字符串多字段查詢"><span class="nav-number">5.</span> <span class="nav-text">Query &amp; Filtering 與多字符串多字段查詢</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Query-Context-amp-Filter-Context"><span class="nav-number">5.1.</span> <span class="nav-text">Query Context &amp; Filter Context</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Bool-Query"><span class="nav-number">5.2.</span> <span class="nav-text">Bool Query</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#範例"><span class="nav-number">5.3.</span> <span class="nav-text">範例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#包含多個子查詢的-Bool-Query"><span class="nav-number">5.3.1.</span> <span class="nav-text">包含多個子查詢的 Bool Query</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#複雜的-Bool-Query"><span class="nav-number">5.3.2.</span> <span class="nav-text">複雜的 Bool Query</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#不同的算分標準"><span class="nav-number">5.3.3.</span> <span class="nav-text">不同的算分標準</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#搭配-boosting-進行查詢"><span class="nav-number">5.3.4.</span> <span class="nav-text">搭配 boosting 進行查詢</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#單字符串多字段查詢：Disjunction-Max-Query"><span class="nav-number">6.</span> <span class="nav-text">單字符串多字段查詢：Disjunction Max Query</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#單字符串多字段查詢：Multi-Match"><span class="nav-number">7.</span> <span class="nav-text">單字符串多字段查詢：Multi Match</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#全文檢索案例"><span class="nav-number">8.</span> <span class="nav-text">全文檢索案例</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#思考-amp-分析"><span class="nav-number">8.1.</span> <span class="nav-text">思考 &amp; 分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#相關性測試"><span class="nav-number">8.2.</span> <span class="nav-text">相關性測試</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#監控-amp-理解用戶行為"><span class="nav-number">8.3.</span> <span class="nav-text">監控 &amp; 理解用戶行為</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#使用-Search-Template-和-Index-Alias-查詢"><span class="nav-number">9.</span> <span class="nav-text">使用 Search Template 和 Index Alias 查詢</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Search-Template"><span class="nav-number">9.1.</span> <span class="nav-text">Search Template</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Index-Alias"><span class="nav-number">9.2.</span> <span class="nav-text">Index Alias</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#綜合排序：Function-Score-Query-優化算分"><span class="nav-number">10.</span> <span class="nav-text">綜合排序：Function Score Query 優化算分</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Scoring-amp-Sorting"><span class="nav-number">10.1.</span> <span class="nav-text">Scoring &amp; Sorting</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Function-Score-Query"><span class="nav-number">10.2.</span> <span class="nav-text">Function Score Query</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Boost-Mode-amp-Max-Boost"><span class="nav-number">10.3.</span> <span class="nav-text">Boost Mode &amp; Max Boost</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#一致性的隨機函數"><span class="nav-number">10.4.</span> <span class="nav-text">一致性的隨機函數</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Term-amp-Phrase-Suggester"><span class="nav-number">11.</span> <span class="nav-text">Term &amp; Phrase Suggester</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#什麼是搜尋建議"><span class="nav-number">11.1.</span> <span class="nav-text">什麼是搜尋建議?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Elasticsearch-Suggester-API"><span class="nav-number">11.2.</span> <span class="nav-text">Elasticsearch Suggester API</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Completion-amp-Context-Suggester"><span class="nav-number">12.</span> <span class="nav-text">Completion &amp; Context Suggester</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Completion-Suggester"><span class="nav-number">12.1.</span> <span class="nav-text">Completion Suggester</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Context-Suggester"><span class="nav-number">12.2.</span> <span class="nav-text">Context Suggester</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#如何實作-Context-Suggester"><span class="nav-number">12.3.</span> <span class="nav-text">如何實作 Context Suggester ?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#關於-Precision-精準度-amp-Recall-招回率"><span class="nav-number">12.4.</span> <span class="nav-text">關於 Precision(精準度) &amp; Recall(招回率)</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Cross-Cluster-Search"><span class="nav-number">13.</span> <span class="nav-text">Cross Cluster Search</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#水平擴展的問題"><span class="nav-number">13.1.</span> <span class="nav-text">水平擴展的問題</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cross-Cluster-Search-1"><span class="nav-number">13.2.</span> <span class="nav-text">Cross Cluster Search</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">godleon</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 強力驅動</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主題 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/blog/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/blog/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/blog/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/blog/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/blog/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/blog/js/src/bootstrap.js?v=5.1.3"></script>



  


  

    
      <script id="dsq-count-scr" src="https://godleon-blog-hexo.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'https://godleon.github.io/blog/Elasticsearch/Elasticsearch-advanced-search/';
          this.page.identifier = 'Elasticsearch/Elasticsearch-advanced-search/';
          this.page.title = '[Elasticsearch] 深入搜索';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://godleon-blog-hexo.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  











<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="//unpkg.com/valine/dist/Valine.min.js"></script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/blog/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
