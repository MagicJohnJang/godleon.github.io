<!DOCTYPE html>
<html lang="zh-tw">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">


<link rel="stylesheet" href="/blog/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"godleon.github.io","root":"/blog/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="此篇文章是在極客時間學習 Elasticsearch 課程時留下的一些學習筆記，主要內容包含 Elasticsearch 的基本概念 &amp; 搜尋入門">
<meta property="og:type" content="article">
<meta property="og:title" content="[Elasticsearch] 基本概念 &amp; 搜尋入門">
<meta property="og:url" content="https://godleon.github.io/blog/Elasticsearch/Elasticsearch-getting-started/index.html">
<meta property="og:site_name" content="小信豬的原始部落">
<meta property="og:description" content="此篇文章是在極客時間學習 Elasticsearch 課程時留下的一些學習筆記，主要內容包含 Elasticsearch 的基本概念 &amp; 搜尋入門">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_invert-index-1.png">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_posting-list-example.png">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_analyzer-1.png">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_precision-and-recall.png">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_search-example-01.png">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_search-example-02.png">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_search-example-03.png">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_search-example-04.png">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_search-example-06.png">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_search-example-05.png">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_search-example-07.png">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_search-example-08.png">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_search-example-09.png">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_search-example-10.png">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_aggregation-01.png">
<meta property="article:published_time" content="2019-10-25T22:25:00.000Z">
<meta property="article:modified_time" content="2020-07-31T00:37:52.120Z">
<meta property="article:author" content="godleon">
<meta property="article:tag" content="Elasticsearch">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_invert-index-1.png">

<link rel="canonical" href="https://godleon.github.io/blog/Elasticsearch/Elasticsearch-getting-started/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-tw'
  };
</script>

  <title>[Elasticsearch] 基本概念 & 搜尋入門 | 小信豬的原始部落</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-703592-7"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-703592-7');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">小信豬的原始部落</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/blog/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/blog/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/blog/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blog/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-tw">
    <link itemprop="mainEntityOfPage" href="https://godleon.github.io/blog/Elasticsearch/Elasticsearch-getting-started/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="godleon">
      <meta itemprop="description" content="把時間花在哪裡，成就就在哪裡">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小信豬的原始部落">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          [Elasticsearch] 基本概念 & 搜尋入門
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-10-26 06:25:00" itemprop="dateCreated datePublished" datetime="2019-10-26T06:25:00+08:00">2019-10-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-07-31 08:37:52" itemprop="dateModified" datetime="2020-07-31T08:37:52+08:00">2020-07-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Elasticsearch/" itemprop="url" rel="index"><span itemprop="name">Elasticsearch</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/blog/Elasticsearch/Elasticsearch-getting-started/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="Elasticsearch/Elasticsearch-getting-started/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
            <div class="post-description">此篇文章是在極客時間學習 Elasticsearch 課程時留下的一些學習筆記，主要內容包含 Elasticsearch 的基本概念 & 搜尋入門</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="基本概念：Index、Document-和-REST-API"><a href="#基本概念：Index、Document-和-REST-API" class="headerlink" title="基本概念：Index、Document 和 REST API"></a>基本概念：Index、Document 和 REST API</h1><ul>
<li>Index &amp; Document 是比較偏向開發人員視角</li>
</ul>
<h2 id="Document"><a href="#Document" class="headerlink" title="Document"></a>Document</h2><ul>
<li><p>Document 是可以被搜尋數據的最小單位(可能是 log 文件中的一筆紀錄 or 一部電影或唱片的相關訊息)：</p>
</li>
<li><p>Document 會被序列化成 JSON(由一堆 Key/Value 的資料組成，並有其資料格式) 格式，保存在 Elasticsearch 中</p>
</li>
<li><p>每個 Document 都有一個 UID(Unique ID)，可自己指定或交由 Elasticsearch 自動產生</p>
</li>
</ul>
<h2 id="JSON-document"><a href="#JSON-document" class="headerlink" title="JSON document"></a>JSON document</h2><ul>
<li><p>包含多個 Key/Value 組合，就像是資料庫中的一筆資料</p>
</li>
<li><p>但跟資料庫不一樣的是，JSON 格式靈活不受限，不須預先定義格式</p>
</li>
<li><p>每個 Key/Value 的類型(string, number, boolean … etc)) 可以自己指定或是由 Elasticsearch 幫忙推算</p>
</li>
</ul>
<h1 id="基本概念：Node、Cluster、Shard-及-Replication"><a href="#基本概念：Node、Cluster、Shard-及-Replication" class="headerlink" title="基本概念：Node、Cluster、Shard 及 Replication"></a>基本概念：Node、Cluster、Shard 及 Replication</h1><ul>
<li>Node &amp; Shard 是比較偏向維運人員的視角</li>
</ul>
<h1 id="Document-的基本-CRUD-與批次操作"><a href="#Document-的基本-CRUD-與批次操作" class="headerlink" title="Document 的基本 CRUD 與批次操作"></a>Document 的基本 CRUD 與批次操作</h1><ul>
<li><p>Index(刪除再建立), Create(建立新的 document，如果已經存在會發生錯誤), Update(對 document 做增量更新)</p>
</li>
<li><p>呼叫 API 時傳輸的數據不宜過大(預設單一個 document 大小不能超過 100MB)，過大的 document 建議拆成 5~15MB 分次匯入</p>
</li>
<li><p>大版本的升級，document 必須重建 index</p>
</li>
<li><p>Elasticsearch 預設會提供 dynamic mapping 的功能，因此不用預先設定好 index 結構；但在生產環境中，建議先做好 mapping 的設定後再寫入資料</p>
</li>
<li><p>透過 X-Pack security plugin，可以提供 index-level or field-level 的 role based 資料存取控制</p>
</li>
</ul>
<h2 id="API-行為區分"><a href="#API-行為區分" class="headerlink" title="API 行為區分"></a>API 行為區分</h2><ul>
<li><p>index： 針對整個文檔，既可以新增又可以更新；</p>
</li>
<li><p>create：只是新增操作，已有報錯，可以用PUT指定ID，或POST不指定ID；</p>
</li>
<li><p>update：指的是部分更新，官方只是說用POST，請求body裡用script或 doc裡包含文檔要更新的部分；</p>
</li>
<li><p>delete和read：就是delete和get請求了，比較簡單</p>
</li>
</ul>
<h1 id="Inverted-Index-倒排索引-介紹"><a href="#Inverted-Index-倒排索引-介紹" class="headerlink" title="Inverted Index(倒排索引)介紹"></a>Inverted Index(倒排索引)介紹</h1><ul>
<li><p>Forward Index(正排索引)：Document ID 到 Document 內容到單詞的關聯</p>
</li>
<li><p>Inverted Index(倒排索引)：單詞到 Document ID 的關係</p>
</li>
</ul>
<p><img src="/blog/images/Elasticsearch/es_invert-index-1.png" alt="Elasticsearch - Inverted Index"></p>
<h2 id="Inverted-Index-組成"><a href="#Inverted-Index-組成" class="headerlink" title="Inverted Index 組成"></a>Inverted Index 組成</h2><ul>
<li><p>Term Dictionary (單詞辭典)</p>
<blockquote>
<p>記錄 Document 中所有的單詞，記錄單詞到 posting list 的關聯關係</p>
</blockquote>
</li>
<li><p>Posting List (倒排列表)</p>
<blockquote>
<p>由 posting(倒排索引項組合)</p>
</blockquote>
</li>
<li><p>Elasticsearch 的 JSON document 中的單詞都會有自己的倒排索引</p>
</li>
<li><p>可以對某些 term(字段)不作索引：</p>
<ul>
<li>優點：節省儲存空間</li>
<li>缺點：字段無法被搜索</li>
</ul>
</li>
</ul>
<h2 id="Posting-List"><a href="#Posting-List" class="headerlink" title="Posting List"></a>Posting List</h2><ul>
<li>posting(倒排索引項) 包含以下內容：<ul>
<li>Document ID</li>
<li>詞頻 (Term Frequency)：單詞在 document 中出現的次數，用在相關性評分</li>
<li>位置 (Position)：單詞在 document 的位置，用在搜尋</li>
<li>偏移 (Offset)：記錄單詞開始 &amp; 結束位置，用於高亮顯示</li>
</ul>
</li>
</ul>
<p><img src="/blog/images/Elasticsearch/es_posting-list-example.png" alt="Elasticsearch - Posting List"></p>
<p>索引號對應索引穩定的內容，比如：書的第一頁有啥內容?第二頁有啥內容?</p>
<ul>
<li>Inverted Index</li>
</ul>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/inverted-index.html" target="_blank" rel="noopener">倒排索引 | Elasticsearch: 權威指南 | Elastic</a></li>
</ul>
<h1 id="通過Analyzer進行分詞"><a href="#通過Analyzer進行分詞" class="headerlink" title="通過Analyzer進行分詞"></a>通過Analyzer進行分詞</h1><ul>
<li><p>Analysis 是將 document 轉換唯一系列單詞(term/token) 的過程，也叫<strong>分詞</strong></p>
</li>
<li><p>Analysis 是由 Analyzer 來實現，Analyzer 由 <code>Character Filter</code> -&gt; <code>Tokenizer</code> -&gt; <code>Token Filter</code> 三個部份所組成，每個部份都可以自訂</p>
</li>
</ul>
<h2 id="Analyzer-的組成"><a href="#Analyzer-的組成" class="headerlink" title="Analyzer 的組成"></a>Analyzer 的組成</h2><p>Analyzer 是專門處理分詞的組件，由三個部份組成：</p>
<ul>
<li><p>Character Filter (針對原始文件進行處理，例如：去除 HTML tag)</p>
</li>
<li><p>Tokenizer (根據規則切分 term)</p>
</li>
<li><p>Token Filter (將分割後的 term 進行加工，例如：轉小寫、刪除 <a href="https://zh.wikipedia.org/wiki/%E5%81%9C%E7%94%A8%E8%AF%8D" target="_blank" rel="noopener">stopwords</a>、增加同義詞)</p>
</li>
</ul>
<p><img src="/blog/images/Elasticsearch/es_analyzer-1.png" alt="Elasticsearch - Analyzer"></p>
<ul>
<li>Elasticsearch 內建很多 Analyzer，每個 Analyzer 會由不同的 character filter, tokenizer, token filter 組合而成，使用者也可以自訂 Analyzer</li>
</ul>
<h2 id="Elasticsearch-內建的-Analyzer"><a href="#Elasticsearch-內建的-Analyzer" class="headerlink" title="Elasticsearch 內建的 Analyzer"></a>Elasticsearch 內建的 Analyzer</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># character filter: standard (按詞切分)</span></span><br><span class="line"><span class="comment"># tokenizer: 轉小寫</span></span><br><span class="line"><span class="comment"># token filter: N/A (stopword 會保留)</span></span><br><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"analyzer"</span>: <span class="string">"standard"</span>,</span><br><span class="line">  <span class="string">"text"</span>: <span class="string">"2 running Quick brown-foxes leap over lazy dogs in the summer evening."</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># character filter: simple (按詞切分，去除非字母字元)</span></span><br><span class="line"><span class="comment"># tokenizer: 轉小寫</span></span><br><span class="line"><span class="comment"># token filter: N/A (stopword 會保留)</span></span><br><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"analyzer"</span>: <span class="string">"simple"</span>,</span><br><span class="line">  <span class="string">"text"</span>: <span class="string">"2 running Quick brown-foxes leap over lazy dogs in the summer evening."</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># character filter: simple (按詞切分，去除非字母字元)</span></span><br><span class="line"><span class="comment"># tokenizer: 轉小寫</span></span><br><span class="line"><span class="comment"># token filter: 去除 stopwords</span></span><br><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"analyzer"</span>: <span class="string">"stop"</span>,</span><br><span class="line">  <span class="string">"text"</span>: <span class="string">"2 running Quick brown-foxes leap over lazy dogs in the summer evening."</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># character filter: whitespace (單純以空白切分)</span></span><br><span class="line"><span class="comment"># tokenizer: 轉小寫</span></span><br><span class="line"><span class="comment"># token filter: N/A (stopword 會保留)</span></span><br><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"analyzer"</span>: <span class="string">"whitespace"</span>,</span><br><span class="line">  <span class="string">"text"</span>: <span class="string">"2 running Quick brown-foxes leap over lazy dogs in the summer evening."</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># character filter: N/A (不進行分詞)</span></span><br><span class="line"><span class="comment"># tokenizer: keyword (將所有的輸入直接轉成 token)</span></span><br><span class="line"><span class="comment"># token filter: N/A</span></span><br><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"analyzer"</span>: <span class="string">"keyword"</span>,</span><br><span class="line">  <span class="string">"text"</span>: <span class="string">"2 running Quick brown-foxes leap over lazy dogs in the summer evening."</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># character filter: pattern (使用正規表示式分詞)</span></span><br><span class="line"><span class="comment"># tokenizer: 轉小寫</span></span><br><span class="line"><span class="comment"># token filter: N/A (stopword 會保留)</span></span><br><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"analyzer"</span>: <span class="string">"pattern"</span>,</span><br><span class="line">  <span class="string">"text"</span>: <span class="string">"2 running Quick brown-foxes leap over lazy dogs in the summer evening."</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># character filter: english (使用英文辭典分詞)</span></span><br><span class="line"><span class="comment"># tokenizer: 轉小寫</span></span><br><span class="line"><span class="comment"># token filter: # token filter: 去除 stopwords</span></span><br><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"analyzer"</span>: <span class="string">"english"</span>,</span><br><span class="line">  <span class="string">"text"</span>: <span class="string">"2 running Quick brown-foxes leap over lazy dogs in the summer evening."</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="Search-API-概覽"><a href="#Search-API-概覽" class="headerlink" title="Search API 概覽"></a>Search API 概覽</h1><ul>
<li>search API 分成 <code>URI search</code>(使用 GET) &amp; <code>request body search</code>(同時支援 GET &amp; POST，使用 ES 提供的 DSL)</li>
</ul>
<p>查詢範圍：</p>
<table>
<thead>
<tr>
<th>語法</th>
<th>範圍</th>
</tr>
</thead>
<tbody><tr>
<td><code>/_search</code></td>
<td>cluster 上所有的 index</td>
</tr>
<tr>
<td><code>/index1/_search</code></td>
<td>index1</td>
</tr>
<tr>
<td><code>/index1,index2/_search</code></td>
<td>index1 + index2</td>
</tr>
<tr>
<td><code>/index*/_search</code></td>
<td>以 <strong>index</strong> 開頭的 index</td>
</tr>
</tbody></table>
<h2 id="URI-查詢"><a href="#URI-查詢" class="headerlink" title="URI 查詢"></a>URI 查詢</h2><h2 id="衡量相關性"><a href="#衡量相關性" class="headerlink" title="衡量相關性"></a>衡量相關性</h2><p>Information Retrieval</p>
<ul>
<li><p>Precision (查準率)：盡可能返回較少的無關 document</p>
</li>
<li><p>Recall (查全率)：盡量返回較多的相關 document</p>
</li>
<li><p>Ranking：是否能夠依照相關度進行排序?</p>
</li>
</ul>
<p><img src="/blog/images/Elasticsearch/es_precision-and-recall.png" alt="Elasticsearch - Precision &amp; Recall"></p>
<h1 id="URI-Search詳解"><a href="#URI-Search詳解" class="headerlink" title="URI Search詳解"></a>URI Search詳解</h1><p>URI search 範例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET /movies/_search?q=2012&amp;df=title&amp;sort=year:desc&amp;from=0&amp;size=10&amp;timeout=1s</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"profile"</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>q</code>：指定查詢語句，使用 <strong>Query String Syntax</strong></p>
</li>
<li><p><code>df</code>：預設查詢的 field，若不指定則會對所有的 field 進行查詢</p>
</li>
<li><p><code>sort</code>：排序</p>
</li>
<li><p><code>from</code> &amp; <code>size</code> 用於分頁</p>
</li>
<li><p><code>profile</code>：可以檢查查詢是如何被執行的</p>
</li>
</ul>
<h2 id="搜尋範例"><a href="#搜尋範例" class="headerlink" title="搜尋範例"></a>搜尋範例</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基本查詢</span></span><br><span class="line"><span class="comment"># 明確指定 q, df, sort, from, size, timeout ... 等關鍵字</span></span><br><span class="line"><span class="comment"># 以 TermQuery 的方式查詢</span></span><br><span class="line">GET /movies/_search?q=2012&amp;df=title&amp;sort=year:desc&amp;from=0&amp;size=10&amp;timeout=1s</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"profile"</span>: <span class="string">"true"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/blog/images/Elasticsearch/es_search-example-01.png" alt="Elasticsearch - Search Example 1"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 泛查詢 =&gt; 對所有的 term 進行查詢</span></span><br><span class="line"><span class="comment"># 以 DisjunctionMaxQuery 的方式查詢</span></span><br><span class="line">GET /movies/_search?q=2012</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"profile"</span>:<span class="string">"true"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/blog/images/Elasticsearch/es_search-example-02.png" alt="Elasticsearch - Search Example 2"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 title 中尋找 "Beautiful OR Mind"</span></span><br><span class="line"><span class="comment"># 搜尋效果 =&gt; TermQuery(title:beautiful) + DisjunctionMaxQuery(在所有 term 中搜尋 mind)</span></span><br><span class="line"><span class="comment"># search type = BooleanQuery</span></span><br><span class="line">GET /movies/_search?q=title:Beautiful Mind</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"profile"</span>:<span class="string">"true"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/blog/images/Elasticsearch/es_search-example-03.png" alt="Elasticsearch - Search Example 3"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用引號 =&gt; "Beautiful Mind" = "Beautiful AND Mind"</span></span><br><span class="line"><span class="comment"># search type 為 PhraseQuery (同時出現 &amp; 按照順序)</span></span><br><span class="line">GET /movies/_search?q=title:<span class="string">"Beautiful Mind"</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"profile"</span>:<span class="string">"true"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用括號 =&gt; (Beautiful AND Mind) = "Beautiful AND Mind"</span></span><br><span class="line"><span class="comment"># search type 為 BooleanQuery</span></span><br><span class="line">GET /movies/_search?q=title:(Beautiful AND Mind)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"profile"</span>:<span class="string">"true"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/blog/images/Elasticsearch/es_search-example-04.png" alt="Elasticsearch - Search Example 4"></p>
<p><img src="/blog/images/Elasticsearch/es_search-example-06.png" alt="Elasticsearch - Search Example 6"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用括號 =&gt; (Beautiful Mind) = "Beautiful OR Mind"</span></span><br><span class="line"><span class="comment"># 搜尋效果 =&gt; TermQuery(title:beautiful) + TermQuery(title:mind)</span></span><br><span class="line"><span class="comment"># search type 為 BooleanQuery</span></span><br><span class="line">GET /movies/_search?q=title:(Beautiful Mind)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"profile"</span>:<span class="string">"true"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 title 中尋找 "Beautiful +Mind" (%2 = +)</span></span><br><span class="line"><span class="comment"># 搜尋效果 =&gt; TermQuery(title:beautiful) + TermQuery(+title:mind)</span></span><br><span class="line"><span class="comment"># mind 一定要出現，但 beautiful 不一定要出現</span></span><br><span class="line"><span class="comment"># search type = BooleanQuery</span></span><br><span class="line">GET /movies/_search?q=title:(Beautiful %2BMind)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"profile"</span>:<span class="string">"true"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/blog/images/Elasticsearch/es_search-example-05.png" alt="Elasticsearch - Search Example 5"></p>
<p><img src="/blog/images/Elasticsearch/es_search-example-07.png" alt="Elasticsearch - Search Example 7"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#正規表示式查詢</span></span><br><span class="line"><span class="comment"># 查詢出任何一個 term 為 b 開頭的 document</span></span><br><span class="line"><span class="comment"># search type = MultiTermQueryConstantScoreWrapper</span></span><br><span class="line">GET /movies/_search?q=title:b*</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"profile"</span>:<span class="string">"true"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/blog/images/Elasticsearch/es_search-example-08.png" alt="Elasticsearch - Search Example 8"></p>
<blockquote>
<p>查詢效率低，記憶體消耗大，不建議使用</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 模糊查詢 (即使 search term 有輸入錯誤，還是可以查詢)</span></span><br><span class="line"><span class="comment"># "Beautiful Girls", "Beautiful People", "Beautiful Thing" ... 都會被搜尋到</span></span><br><span class="line">GET /movies/_search?q=title:beautifl~1</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"profile"</span>:<span class="string">"true"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模糊查詢</span></span><br><span class="line"><span class="comment"># "Lord of the Rings: The Two Towers, The", "Lord of the Rings, The" ... 都會被搜尋到</span></span><br><span class="line">GET /movies/_search?q=title:<span class="string">"Lord Rings"</span>~2</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"profile"</span>:<span class="string">"true"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/blog/images/Elasticsearch/es_search-example-09.png" alt="Elasticsearch - Search Example 9"></p>
<p><img src="/blog/images/Elasticsearch/es_search-example-10.png" alt="Elasticsearch - Search Example 10"></p>
<h1 id="Request-Body-與-Query-DSL-簡介"><a href="#Request-Body-與-Query-DSL-簡介" class="headerlink" title="Request Body 與 Query DSL 簡介"></a>Request Body 與 Query DSL 簡介</h1><ul>
<li>進階的查詢通常只能用 request body 的方式完成</li>
</ul>
<h2 id="一般查詢範例"><a href="#一般查詢範例" class="headerlink" title="一般查詢範例"></a>一般查詢範例</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ignore_unavailable=true，可以忽略嘗試訪問不存在的 index “404_idx” 導致的錯誤</span></span><br><span class="line"><span class="comment"># 查詢 movies index</span></span><br><span class="line"><span class="comment"># 開啟 profile</span></span><br><span class="line">POST /movies,404_idx/_search?ignore_unavailable=<span class="literal">true</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"profile"</span>: <span class="literal">true</span>,</span><br><span class="line">	<span class="string">"query"</span>: &#123;</span><br><span class="line">		<span class="string">"match_all"</span>: &#123;&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 透過 from &amp; size 達到分頁效果</span></span><br><span class="line">POST /kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"from"</span>:10,</span><br><span class="line">  <span class="string">"size"</span>:20,</span><br><span class="line">  <span class="string">"query"</span>:&#123;</span><br><span class="line">    <span class="string">"match_all"</span>: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 對資料排序，使用 sort 參數</span></span><br><span class="line">POST kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"sort"</span>:[&#123;<span class="string">"order_date"</span>:<span class="string">"desc"</span>&#125;],</span><br><span class="line">  <span class="string">"query"</span>:&#123;</span><br><span class="line">    <span class="string">"match_all"</span>: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># source filtering</span></span><br><span class="line"><span class="comment"># 當某些 document 很大時，僅針對特定的幾個 term 做查詢</span></span><br><span class="line">POST kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"_source"</span>:[<span class="string">"order_date"</span>, <span class="string">"category.keyword"</span>],</span><br><span class="line">  <span class="string">"from"</span>: 10,</span><br><span class="line">  <span class="string">"size"</span>: 5, </span><br><span class="line">  <span class="string">"query"</span>:&#123;</span><br><span class="line">    <span class="string">"match_all"</span>: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Scripted-Field-腳本字段-Query"><a href="#Scripted-Field-腳本字段-Query" class="headerlink" title="Scripted Field(腳本字段) Query"></a>Scripted Field(腳本字段) Query</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 透過 ES 中 painless script 算出新的 field value</span></span><br><span class="line"><span class="comment"># 搜尋結果中都會加上 hello 作為結尾</span></span><br><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"script_fields"</span>: &#123;</span><br><span class="line">    <span class="string">"new_field"</span>: &#123;</span><br><span class="line">      <span class="string">"script"</span>: &#123;</span><br><span class="line">        <span class="string">"lang"</span>: <span class="string">"painless"</span>,</span><br><span class="line">        <span class="string">"source"</span>: <span class="string">"doc['order_date'].value+'hello'"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"from"</span>: 10, </span><br><span class="line">  <span class="string">"size"</span>: 5,</span><br><span class="line">  <span class="string">"query"</span>: &#123;</span><br><span class="line">    <span class="string">"match_all"</span>: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用查詢表達式-Match"><a href="#使用查詢表達式-Match" class="headerlink" title="使用查詢表達式 - Match"></a>使用查詢表達式 - Match</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 預設為 "last OR christmas"</span></span><br><span class="line">POST movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"query"</span>: &#123;</span><br><span class="line">    <span class="string">"match"</span>: &#123;</span><br><span class="line">      <span class="string">"title"</span>: <span class="string">"last christmas"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可透過 operator 改為 "last AND christmas"</span></span><br><span class="line">POST movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"query"</span>: &#123;</span><br><span class="line">    <span class="string">"match"</span>: &#123;</span><br><span class="line">      <span class="string">"title"</span>: &#123;</span><br><span class="line">        <span class="string">"query"</span>: <span class="string">"last christmas"</span>,</span><br><span class="line">        <span class="string">"operator"</span>: <span class="string">"and"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用查詢表達式-Match-Phrase"><a href="#使用查詢表達式-Match-Phrase" class="headerlink" title="使用查詢表達式 - Match Phrase"></a>使用查詢表達式 - Match Phrase</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 必須按照順序出現</span></span><br><span class="line">POST movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"query"</span>: &#123;</span><br><span class="line">    <span class="string">"match_phrase"</span>: &#123;</span><br><span class="line">      <span class="string">"title"</span>:&#123;</span><br><span class="line">        <span class="string">"query"</span>: <span class="string">"one love"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加上 slop，中間可以有一個其他的 term 插入</span></span><br><span class="line">POST movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"query"</span>: &#123;</span><br><span class="line">    <span class="string">"match_phrase"</span>: &#123;</span><br><span class="line">      <span class="string">"title"</span>:&#123;</span><br><span class="line">        <span class="string">"query"</span>: <span class="string">"one love"</span>,</span><br><span class="line">        <span class="string">"slop"</span>: 1</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="Query-String-amp-Simple-Query-String-查詢"><a href="#Query-String-amp-Simple-Query-String-查詢" class="headerlink" title="Query String &amp; Simple Query String 查詢"></a>Query String &amp; Simple Query String 查詢</h1><h2 id="Query-String-Query"><a href="#Query-String-Query" class="headerlink" title="Query String Query"></a>Query String Query</h2><ul>
<li>類似 URI Query</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 可指定 default field(DF)</span></span><br><span class="line"><span class="comment"># 可指定 operrator</span></span><br><span class="line">POST users/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"query"</span>: &#123;</span><br><span class="line">    <span class="string">"query_string"</span>: &#123;</span><br><span class="line">      <span class="string">"default_field"</span>: <span class="string">"tool"</span>,</span><br><span class="line">      <span class="string">"query"</span>: <span class="string">"Docker AND Kubernetes"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可指定多個 field</span></span><br><span class="line">POST users/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"query"</span>: &#123;</span><br><span class="line">    <span class="string">"query_string"</span>: &#123;</span><br><span class="line">      <span class="string">"fields"</span>:[<span class="string">"tool"</span>,<span class="string">"about"</span>],</span><br><span class="line">      <span class="string">"query"</span>: <span class="string">"(Docker AND Kubernetes) OR (Java AND Elasticsearch)"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="Simple-Query-String-Query"><a href="#Simple-Query-String-Query" class="headerlink" title="Simple Query String Query"></a>Simple Query String Query</h2><ul>
<li><p>類似 Query String, 但會忽略錯誤的語法，並且僅支援部份查詢語法</p>
</li>
<li><p>不支援 <strong>AND</strong>/<strong>OR</strong>/<strong>NOT</strong>，會當作 term 來處理</p>
</li>
<li><p>term 之間預設的關係是 <code>OR</code>，可指定 <code>operator</code></p>
</li>
<li><p>支援使用 <code>+</code> 取代 <code>AND</code>，<code>|</code> 取代 <code>OR</code>，<code>-</code> 取代 <code>NOT</code></p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST users/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"query"</span>: &#123;</span><br><span class="line">    <span class="string">"simple_query_string"</span>: &#123;</span><br><span class="line">      <span class="string">"query"</span>: <span class="string">"Docker Kubernetes"</span>,</span><br><span class="line">      <span class="string">"fields"</span>: [<span class="string">"tool"</span>],</span><br><span class="line">      <span class="string">"default_operator"</span>: <span class="string">"AND"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="Dynamic-Mapping-和常見字段類型"><a href="#Dynamic-Mapping-和常見字段類型" class="headerlink" title="Dynamic Mapping 和常見字段類型"></a>Dynamic Mapping 和常見字段類型</h1><h2 id="What-is-Mapping"><a href="#What-is-Mapping" class="headerlink" title="What is Mapping ?"></a>What is Mapping ?</h2><ul>
<li><p>Mapping 類似資料庫中的 schema 定義，用途如下：</p>
<ul>
<li><p>定義 index 中每個 term 的名稱</p>
</li>
<li><p>定義每個 term 的資料型態，例如：string, Interger, boolean</p>
</li>
<li><p>term &amp; inverted index 的相關配置 (要使用哪個 Analyzer，或是不被索引)</p>
</li>
</ul>
</li>
<li><p>Mapping 會將 JSON document 映射成 Lucene 所需要的扁平格式</p>
</li>
<li><p>一個 Mapping 屬於一個 index type</p>
<ul>
<li><p>每個 document 都屬於一個 type</p>
</li>
<li><p>一個 type 都會有一個 mapping 定義</p>
</li>
<li><p>7.0 開始，不需要在 mapping 定義中指定 type 資訊</p>
</li>
</ul>
</li>
</ul>
<h2 id="Term-Data-Type"><a href="#Term-Data-Type" class="headerlink" title="Term Data Type"></a>Term Data Type</h2><h3 id="簡單類型"><a href="#簡單類型" class="headerlink" title="簡單類型"></a>簡單類型</h3><ul>
<li><p>Text / Keyword</p>
</li>
<li><p>Date</p>
</li>
<li><p>Integer / Floating</p>
</li>
<li><p>Boolean</p>
</li>
<li><p>IPv4 &amp; IPv6</p>
</li>
</ul>
<h3 id="複雜類型"><a href="#複雜類型" class="headerlink" title="複雜類型"></a>複雜類型</h3><ul>
<li><p>Object</p>
</li>
<li><p>List</p>
</li>
</ul>
<h3 id="特殊類型"><a href="#特殊類型" class="headerlink" title="特殊類型"></a>特殊類型</h3><ul>
<li><p>geo_point &amp; geo_shape (地理訊息)</p>
</li>
<li><p>percolator</p>
</li>
</ul>
<h2 id="What-is-Dynamic-Mapping"><a href="#What-is-Dynamic-Mapping" class="headerlink" title="What is Dynamic Mapping ?"></a>What is Dynamic Mapping ?</h2><ul>
<li><p>在寫入 Document 時，如果 index 不存在，則會自動建立 index</p>
</li>
<li><p>Dynamic Mapping 可以根據 Document 內容，推算出 term data type 並自動建立 mapping，因此不需要手動制定</p>
</li>
<li><p>但推算的結果不一定會完全正確(例如：地理位置相關訊息可能會推斷錯誤)</p>
</li>
<li><p>term data type 推算錯誤可能會導致某些查詢無法正常使用，例如：range 查詢</p>
</li>
</ul>
<h2 id="範例"><a href="#範例" class="headerlink" title="範例"></a>範例</h2><p>簡單測試 Dynamic Mapping：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 寫入 document，mapping 會動態產生</span></span><br><span class="line">PUT mapping_test/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"firstName"</span>:<span class="string">"Chan"</span>,</span><br><span class="line">  <span class="string">"lastName"</span>: <span class="string">"Jackie"</span>,</span><br><span class="line">  <span class="string">"loginDate"</span>:<span class="string">"2018-07-24T10:29:48.103Z"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 透過 "_mapping" 可以查看 mapping 資訊</span></span><br><span class="line"><span class="comment"># firstName =&gt; text + keyword</span></span><br><span class="line"><span class="comment"># lastName =&gt; text + keyword</span></span><br><span class="line"><span class="comment"># loginDate =&gt; date</span></span><br><span class="line">GET mapping_test/_mapping</span><br><span class="line"></span><br><span class="line"><span class="comment"># 刪除 index</span></span><br><span class="line">DELETE mapping_test</span><br></pre></td></tr></table></figure>

<p>故意將某些資料類型加上雙引號測試：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># UID 應該為 long，加上雙引號</span></span><br><span class="line"><span class="comment"># isAdmin 應該為 boolean，加上雙引號</span></span><br><span class="line">PUT mapping_test/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"uid"</span> : <span class="string">"123"</span>,</span><br><span class="line">    <span class="string">"isVip"</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"isAdmin"</span>: <span class="string">"true"</span>,</span><br><span class="line">    <span class="string">"age"</span>:19,</span><br><span class="line">    <span class="string">"heigh"</span>:180</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 mapping 設定</span></span><br><span class="line"><span class="comment"># uid =&gt; text + keyword</span></span><br><span class="line"><span class="comment"># isVip =&gt; boolean</span></span><br><span class="line"><span class="comment"># isAdmin =&gt; text + keyword</span></span><br><span class="line"><span class="comment"># age =&gt; long</span></span><br><span class="line"><span class="comment"># height =&gt; long</span></span><br><span class="line">GET mapping_test/_mapping</span><br></pre></td></tr></table></figure>

<h2 id="修改-Mapping-中的字段類型"><a href="#修改-Mapping-中的字段類型" class="headerlink" title="修改 Mapping 中的字段類型"></a>修改 Mapping 中的字段類型</h2><p>在新增加字段的情況下：</p>
<ul>
<li><p>若 dynamic = true，一旦有新增字段的 document 寫入時，mapping 資訊也會同時被更新</p>
</li>
<li><p>若 dynamic = false，mapping 不會被更新，新增字段的資料無法被索引，但是資料會出現在 <code>_source</code> 中</p>
</li>
<li><p>若 dynamic = strict，寫入 document 的操作會發生錯誤</p>
</li>
</ul>
<p>若是針對已經存在的字段，使用其他字段類型的資料進行寫入操作，是無法變更 mapping 設定的，因為一旦當 reverted index 已經生成後，就無法修改；而若是真的要改變字段類型，則是需要透過 <code>Reindex API</code> 來重建索引。</p>
<blockquote>
<p>若是原有字段的數據類型可以隨意修改，這樣會讓原本已經被索引的資料無法被搜尋</p>
</blockquote>
<table>
<thead>
<tr>
<th>Dynamic Mapping 設定</th>
<th>“true”</th>
<th>“false”</th>
<th>“strict”</th>
</tr>
</thead>
<tbody><tr>
<td>document 可索引</td>
<td>Yes</td>
<td>Yes</td>
<td>No (資料寫入會錯誤))</td>
</tr>
<tr>
<td>字段可索引</td>
<td>Yes</td>
<td>No</td>
<td>No</td>
</tr>
<tr>
<td>Mapping 被更新</td>
<td>Yes</td>
<td>No (新增字段被丟棄)</td>
<td>No</td>
</tr>
</tbody></table>
<h2 id="修改-Mapping-範例"><a href="#修改-Mapping-範例" class="headerlink" title="修改 Mapping 範例"></a>修改 Mapping 範例</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 預設 dynamic mapping 開啟，寫入新的 document 進 index 中</span></span><br><span class="line">PUT dynamic_mapping_test/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"newField"</span>:<span class="string">"someValue"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 資料可以被搜尋到，資料也同時出現在 _source 中</span></span><br><span class="line">POST dynamic_mapping_test/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"query"</span>:&#123;</span><br><span class="line">    <span class="string">"match"</span>:&#123;</span><br><span class="line">      <span class="string">"newField"</span>:<span class="string">"someValue"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 將 dynamic mapping 設定為 false</span></span><br><span class="line">PUT dynamic_mapping_test/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"dynamic"</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新增 anotherField</span></span><br><span class="line">POST dynamic_mapping_test/_doc/10</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"anotherField"</span>:<span class="string">"someValue"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># anotherField 這一筆資料無法被搜索，因為 dynamic mapping 已經被設定為 false</span></span><br><span class="line">POST dynamic_mapping_test/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"query"</span>:&#123;</span><br><span class="line">    <span class="string">"match"</span>:&#123;</span><br><span class="line">      <span class="string">"anotherField"</span>:<span class="string">"someValue"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 檢視 mapping 設定，還是只有原本就存在的 newField 設定</span></span><br><span class="line">get dynamic_mapping_test/_mapping</span><br><span class="line"></span><br><span class="line"><span class="comment"># 將 dynamic mapping 設定修改為 strict</span></span><br><span class="line">PUT dynamic_mapping_test/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"dynamic"</span>: <span class="string">"strict"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 此時寫入操作就會發生錯誤，HTTP Code 400</span></span><br><span class="line">PUT dynamic_mapping_test/_doc/12</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"lastField"</span>:<span class="string">"value"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 移除 index</span></span><br><span class="line">DELETE dynamic_mapping_test</span><br></pre></td></tr></table></figure>



<h1 id="顯式-Mapping-設置與常見參數介紹"><a href="#顯式-Mapping-設置與常見參數介紹" class="headerlink" title="顯式 Mapping 設置與常見參數介紹"></a>顯式 Mapping 設置與常見參數介紹</h1><h2 id="自定義-mapping"><a href="#自定義-mapping" class="headerlink" title="自定義 mapping"></a>自定義 mapping</h2><p>往 index 送 PUT request 並帶上 mappings 設定即可：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT movies</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"mappings"</span>: &#123;</span><br><span class="line">    //define your mappings here</span><br><span class="line">  &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>撰寫 mapping 其實不是這麼容易，除了可以參考 API 來撰寫之外，也可以透過<strong>寫入一些 sample data 到一個臨時的 index，讓 Elasticsearch 自動產生 mapping 定義後，再根據實際需求進行修改</strong>。</p>
<h2 id="Index-Options"><a href="#Index-Options" class="headerlink" title="Index Options"></a>Index Options</h2><p>Inverted Index 根據要記錄的內容，有四種 index options 可以設定：</p>
<table>
<thead>
<tr>
<th>Index Option</th>
<th>Inverted Index 中的記錄內容</th>
</tr>
</thead>
<tbody><tr>
<td><code>docs</code></td>
<td>doc id</td>
</tr>
<tr>
<td><code>freqs</code></td>
<td>doc id + term frequency</td>
</tr>
<tr>
<td><code>positions</code></td>
<td>doc id + term frequency + term position</td>
</tr>
<tr>
<td><code>offsets</code></td>
<td>doc id + term frequency + term position + character offsets</td>
</tr>
</tbody></table>
<ul>
<li><p>type <code>text</code> 預設使用 <code>positions</code>，其他則為 <code>docs</code></p>
</li>
<li><p>記錄的資料越多，需要儲存空間越多</p>
</li>
</ul>
<h2 id="選擇性的讓特定-Field-不被索引"><a href="#選擇性的讓特定-Field-不被索引" class="headerlink" title="選擇性的讓特定 Field 不被索引"></a>選擇性的讓特定 Field 不被索引</h2><p>預設情況下每個 field 都會被索引，但若是確定特定的 field 資料不需要被查詢，也可以不被索引：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">PUT users</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"mappings"</span> : &#123;</span><br><span class="line">      <span class="attr">"properties"</span> : &#123;</span><br><span class="line">        <span class="attr">"firstName"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"text"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"lastName"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"text"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">//將 index 設定為 false，ES 就不會索引該 field 的資料</span></span><br><span class="line">        <span class="attr">"mobile"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"text"</span>,</span><br><span class="line">          <span class="attr">"index"</span>: <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 新增資料</span></span><br><span class="line">PUT users/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"firstName"</span>:<span class="string">"Leon"</span>,</span><br><span class="line">  <span class="attr">"lastName"</span>: <span class="string">"Tseng"</span>,</span><br><span class="line">  <span class="attr">"mobile"</span>: <span class="string">"12345678"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 搜尋會發生錯誤</span></span><br><span class="line"><span class="comment">// Cannot search on field [mobile] since it is not indexed.</span></span><br><span class="line">POST /users/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"match"</span>: &#123;</span><br><span class="line">      <span class="attr">"mobile"</span>:<span class="string">"12345678"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="NULL-value-的處理"><a href="#NULL-value-的處理" class="headerlink" title="NULL value 的處理"></a>NULL value 的處理</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">PUT users</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"mappings"</span> : &#123;</span><br><span class="line">      <span class="attr">"properties"</span> : &#123;</span><br><span class="line">        <span class="attr">"firstName"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"text"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"lastName"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"text"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"mobile"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"keyword"</span>,</span><br><span class="line">          <span class="comment">//可以透過給一個 "NULL" 字串的方式</span></span><br><span class="line">          <span class="comment">//讓 ES 協助生成一個 keyword field 來搜尋</span></span><br><span class="line">          <span class="attr">"null_value"</span>: <span class="string">"NULL"</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//新增資料1</span></span><br><span class="line">PUT users/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"firstName"</span>:<span class="string">"Leon"</span>,</span><br><span class="line">  <span class="attr">"lastName"</span>: <span class="string">"Tseng"</span>,</span><br><span class="line">  <span class="attr">"mobile"</span>: <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//新增資料2</span></span><br><span class="line">PUT users/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"firstName"</span>:<span class="string">"Leon2"</span>,</span><br><span class="line">  <span class="attr">"lastName"</span>: <span class="string">"Tseng2"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//只會找到資料1</span></span><br><span class="line"><span class="comment">//而且實際存在於 ES 中的是 null 值而非字串 </span></span><br><span class="line">GET users/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"match"</span>: &#123;</span><br><span class="line">      <span class="attr">"mobile"</span>:<span class="string">"NULL"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="copy-to-設定"><a href="#copy-to-設定" class="headerlink" title="copy_to 設定"></a>copy_to 設定</h2><p>透過 <code>copy_to</code> 的設定可以新增一個 field，實現類似 <code>_all</code> 的效果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">PUT users</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"mappings"</span>: &#123;</span><br><span class="line">    <span class="attr">"properties"</span>: &#123;</span><br><span class="line">      <span class="attr">"firstName"</span>:&#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"text"</span>,</span><br><span class="line">        <span class="comment">//firstName 資料會被複製到 fullName 中</span></span><br><span class="line">        <span class="attr">"copy_to"</span>: <span class="string">"fullName"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"lastName"</span>:&#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"text"</span>,</span><br><span class="line">        <span class="comment">//lastName 資料會被複製到 fullName 中</span></span><br><span class="line">        <span class="attr">"copy_to"</span>: <span class="string">"fullName"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>_all</code> 在 ES 7 後被 <code>copy_to</code> 取代</p>
</li>
<li><p>上述範例中，使用者可以針對 <code>fullName</code> 進行搜尋</p>
</li>
<li><p><code>fullName</code> 的資料不會出現在 <code>_source</code> 中</p>
</li>
</ul>
<h2 id="Aray-Type"><a href="#Aray-Type" class="headerlink" title="Aray Type"></a>Aray Type</h2><p>目前 Elasticsearch 不支援 array type，但每個 field 都可以包含多個相同類型的數值：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//新增一個帶有 string array 的資料</span></span><br><span class="line">PUT users/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>:<span class="string">"twobirds"</span>,</span><br><span class="line">  <span class="attr">"interests"</span>:[<span class="string">"reading"</span>,<span class="string">"music"</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//可以正確被搜尋</span></span><br><span class="line">POST users/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">		<span class="attr">"match_all"</span>: &#123;&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//而 name 的 data type 被設定為 text</span></span><br><span class="line">GET users/_mapping</span><br></pre></td></tr></table></figure>

<blockquote>
<p>表示 <code>text</code> type 其實是可以記錄 array type 的資料 (其實其他 type 也是可以記錄 array type 資料，例如：<code>long</code>))</p>
</blockquote>
<h1 id="Multiple-Field-特性及-Mapping-中配置自定義-Analyzer"><a href="#Multiple-Field-特性及-Mapping-中配置自定義-Analyzer" class="headerlink" title="Multiple Field 特性及 Mapping 中配置自定義 Analyzer"></a>Multiple Field 特性及 Mapping 中配置自定義 Analyzer</h1><ul>
<li><p>多個 field 資料中，可透過 <code>keyword</code> field 作精確搜尋</p>
</li>
<li><p>若是要做全文搜尋，則是使用 <code>text</code> field 並搭配不同的 <strong>analyzer</strong> &amp; <strong>search analyzer</strong></p>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">PUT products</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"mappings"</span>: &#123;</span><br><span class="line">    <span class="attr">"properties"</span>: &#123;</span><br><span class="line">      <span class="attr">"company"</span>: &#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"text"</span>, </span><br><span class="line">        <span class="attr">"fields"</span>: &#123;</span><br><span class="line">          <span class="comment">//利用 keyword field 來實現精確匹配</span></span><br><span class="line">          <span class="attr">"keyword"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"keyword"</span>, </span><br><span class="line">            <span class="attr">"ignore_above"</span>: <span class="number">256</span> </span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, </span><br><span class="line">      <span class="attr">"comment"</span>: &#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"text"</span>, </span><br><span class="line">        <span class="attr">"fields"</span>: &#123;</span><br><span class="line">          <span class="comment">//針對需要進行全文檢索的欄位，設定不同的 analyzer &amp; search analyzer</span></span><br><span class="line">          <span class="attr">"english_comment"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"text"</span>,</span><br><span class="line">            <span class="attr">"analyzer"</span>: <span class="string">"english"</span>,  <span class="comment">//索引用的 analyzer</span></span><br><span class="line">            <span class="attr">"search_analyzer"</span>: <span class="string">"english"</span>  <span class="comment">//搜尋用的 analyzer</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Exact-Values-v-s-Full-Text"><a href="#Exact-Values-v-s-Full-Text" class="headerlink" title="Exact Values v.s. Full Text"></a>Exact Values v.s. Full Text</h2><ul>
<li><p>Exact Value 包含數字/日期/或是特定的字串(例如：”Apple Store”)，在 Elasticsearch 中的 <code>keyword</code> field 存放的就是這一類的資料</p>
</li>
<li><p>Full Text 則是非結構化的資料，在 Elasticsearch 中的 <code>text</code> field 存放的就是這一類的資料</p>
</li>
<li><p>Exact Values 不需要做分詞處理，而 Full Text 則會需要分詞處理才能更容易被後續利用</p>
</li>
</ul>
<h2 id="自訂分詞器-Analyzer"><a href="#自訂分詞器-Analyzer" class="headerlink" title="自訂分詞器(Analyzer)"></a>自訂分詞器(Analyzer)</h2><p>Analyzer 是專門處理分詞的組件，由三個部份組成：</p>
<ul>
<li><p>Character Filter (針對原始文件進行處理，例如：去除 HTML tag)</p>
</li>
<li><p>Tokenizer (根據規則切分 term or token)</p>
</li>
<li><p>Token Filter (將分割後的 term 進行加工，例如：轉小寫、刪除 <a href="https://zh.wikipedia.org/wiki/%E5%81%9C%E7%94%A8%E8%AF%8D" target="_blank" rel="noopener">stopwords</a>、增加同義詞)</p>
</li>
</ul>
<h3 id="Character-Filter"><a href="#Character-Filter" class="headerlink" title="Character Filter"></a>Character Filter</h3><ul>
<li><p>可同時設定多的 Character Filter</p>
</li>
<li><p>會影響 Tokenizer 的 position &amp; offset 的資訊</p>
</li>
<li><p>目前 Elasticsearch 內建提供的 Character Filter 有 HTML strip、Mapping、Patter replace …等等</p>
</li>
</ul>
<h3 id="Tokenizer"><a href="#Tokenizer" class="headerlink" title="Tokenizer"></a>Tokenizer</h3><ul>
<li><p>將 Character Filter 處理過後的資料，按照一定的規則，切分為詞(term or token)</p>
</li>
<li><p>目前 Elasticsearch 內建提供的 tokenizer 有 <code>whitespace</code>/<code>standard</code>/<code>uax_url_email</code>/<code>pattern</code>/<code>keyword</code>(不做任何處理)/<code>path hierarchy</code></p>
</li>
<li><p>也可以用 Java 實作自己的 tokenizer</p>
</li>
</ul>
<h3 id="Token-Filter"><a href="#Token-Filter" class="headerlink" title="Token Filter"></a>Token Filter</h3><ul>
<li><p>將 Tokenizer 輸出的 term(or token) 進行增加、修改、刪除</p>
</li>
<li><p>目前 目前 Elasticsearch 內建提供的 Token Filter 有 <code>lowercase</code>/<code>stop</code>/<code>synonym</code> …  等等</p>
</li>
</ul>
<h2 id="範例-1"><a href="#範例-1" class="headerlink" title="範例"></a>範例</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//將 HTML tag 去除</span></span><br><span class="line">  <span class="attr">"char_filter"</span>:[<span class="string">"html_strip"</span>],</span><br><span class="line"></span><br><span class="line">  <span class="comment">//keyword 不會進行分詞，會保留全部資料</span></span><br><span class="line">  <span class="attr">"tokenizer"</span>:<span class="string">"keyword"</span>,</span><br><span class="line"></span><br><span class="line">  <span class="attr">"text"</span>: <span class="string">"&lt;b&gt;hello world&lt;/b&gt;"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//會將所有可能的目錄結構的分出來</span></span><br><span class="line">  <span class="comment">//例如："/user", "/user/ymruan", "/user/ymruan/a" .... etc</span></span><br><span class="line">  <span class="attr">"tokenizer"</span>:<span class="string">"path_hierarchy"</span>,</span><br><span class="line">  <span class="attr">"text"</span>:<span class="string">"/user/ymruan/a/b/c/d/e"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//會根據 mapping 設定進行字串的取代</span></span><br><span class="line">  <span class="attr">"char_filter"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"type"</span> : <span class="string">"mapping"</span>,</span><br><span class="line">        <span class="attr">"mappings"</span> : [ <span class="string">"- =&gt; _"</span>]</span><br><span class="line">      &#125;</span><br><span class="line">  ],</span><br><span class="line"></span><br><span class="line">  <span class="comment">//標準分詞</span></span><br><span class="line">  <span class="attr">"tokenizer"</span>: <span class="string">"standard"</span>,</span><br><span class="line">  </span><br><span class="line">  <span class="attr">"text"</span>: <span class="string">"123-456, I-test! test-990 650-555-1234"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//char filter 替換表情符號</span></span><br><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//透過 mapping 將表情符號替換成一般字串</span></span><br><span class="line">  <span class="attr">"char_filter"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"type"</span> : <span class="string">"mapping"</span>,</span><br><span class="line">        <span class="attr">"mappings"</span> : [ <span class="string">":) =&gt; happy"</span>, <span class="string">":( =&gt; sad"</span>]</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line"></span><br><span class="line">  <span class="attr">"tokenizer"</span>: <span class="string">"standard"</span>,</span><br><span class="line">  </span><br><span class="line">    <span class="attr">"text"</span>: [<span class="string">"I am felling :)"</span>, <span class="string">"Feeling :( today"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//使用空白進行分詞</span></span><br><span class="line">  <span class="attr">"tokenizer"</span>: <span class="string">"whitespace"</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">//stop words 會被忽略</span></span><br><span class="line">  <span class="comment">//若改成 ["lowercase", "stop"]，下面的 "The" 就會被過濾掉了</span></span><br><span class="line">  <span class="attr">"filter"</span>: [<span class="string">"stop"</span>],</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//"The" 會保留著，因為首字母並非小寫</span></span><br><span class="line">  <span class="attr">"text"</span>: [<span class="string">"The rain in Spain falls mainly on the plain."</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//使用 regular express 進行資料處理</span></span><br><span class="line">  <span class="attr">"char_filter"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"type"</span> : <span class="string">"pattern_replace"</span>,</span><br><span class="line">        <span class="attr">"pattern"</span> : <span class="string">"http://(.*)"</span>,</span><br><span class="line">        <span class="attr">"replacement"</span> : <span class="string">"$1"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line"></span><br><span class="line">  <span class="attr">"tokenizer"</span>: <span class="string">"standard"</span>,</span><br><span class="line">  </span><br><span class="line">    <span class="attr">"text"</span> : <span class="string">"http://www.elastic.co"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也可以完全自己定義一個 Analyzer：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"settings"</span>: &#123;</span><br><span class="line">    <span class="attr">"analysis"</span>: &#123;</span><br><span class="line">      <span class="attr">"analyzer"</span>: &#123;</span><br><span class="line">        <span class="comment">//裡面使用的 character filter, tokenizer, token filter 幾乎都是下面自行定義的</span></span><br><span class="line">        <span class="attr">"my_custom_analyzer"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"custom"</span>,</span><br><span class="line">          <span class="attr">"char_filter"</span>: [ <span class="string">"emoticons"</span> ], </span><br><span class="line">          <span class="attr">"tokenizer"</span>: <span class="string">"punctuation"</span>,</span><br><span class="line">          <span class="attr">"filter"</span>: [ <span class="string">"lowercase"</span>, <span class="string">"english_stop"</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, </span><br><span class="line">      <span class="comment">//自訂 character filter =&gt; emoticons</span></span><br><span class="line">      <span class="attr">"char_filter"</span>: &#123;</span><br><span class="line">        <span class="attr">"emoticons"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"mapping"</span>, </span><br><span class="line">          <span class="attr">"mappings"</span>: [</span><br><span class="line">            <span class="string">":) =&gt; _happy_"</span>, </span><br><span class="line">            <span class="string">":( =&gt; _sad_"</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, </span><br><span class="line">      <span class="comment">//自訂 tokenizer =&gt; punctuation</span></span><br><span class="line">      <span class="attr">"tokenizer"</span>: &#123;</span><br><span class="line">        <span class="attr">"punctuation"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"pattern"</span>, </span><br><span class="line">          <span class="attr">"pattern"</span>: <span class="string">"[ .,!?]"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, </span><br><span class="line">      <span class="comment">//自訂 token filter =&gt; english_stop</span></span><br><span class="line">      <span class="attr">"filter"</span>: &#123;</span><br><span class="line">        <span class="attr">"english_stop"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"stop"</span>, </span><br><span class="line">          <span class="attr">"stopwords"</span>: <span class="string">"_english_"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//驗證上面自訂的 analyzer</span></span><br><span class="line">POST my_index/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"analyzer"</span>: <span class="string">"my_custom_analyzer"</span>,</span><br><span class="line">  <span class="attr">"text"</span>: <span class="string">"I'm a :) person, and you"</span></span><br></pre></td></tr></table></figure>



<h1 id="Index-Template-和-Dynamic-Template"><a href="#Index-Template-和-Dynamic-Template" class="headerlink" title="Index Template 和 Dynamic Template"></a>Index Template 和 Dynamic Template</h1><ul>
<li>若 cluster 是用來做 log 管理，每天都產生一個專屬的 index 存放 log，數據管理上較為合理，效能表現也會較好</li>
</ul>
<h2 id="Index-Template"><a href="#Index-Template" class="headerlink" title="Index Template"></a>Index Template</h2><p>Index Template 使用來協助使用者設定 mappings &amp; settings 的相關規則，並可透過套用 template 建立新的 index 來取得在 template 中已經存在的設定</p>
<ul>
<li><p>index template 只有在建立 index 有用，後續修改 template 不會影響已經存在的 index</p>
</li>
<li><p>可以設定多個 index template，這些設定會被合併在一起</p>
</li>
<li><p>也可以透過指定 <code>order</code>，來調整 index template 合併的過程</p>
</li>
</ul>
<p>而 index template 是如何在 index 被新增時運作的呢?</p>
<ol>
<li><p>先選用 Elasticsearch 中預設的 settings &amp; mappings</p>
</li>
<li><p>先套用 order 值低的 index template 中的設定</p>
</li>
<li><p>再套用 order 值高的 index template 中的設定，並覆蓋之前的設定</p>
</li>
<li><p>如果建立 index 時使用者有指定 settings &amp; mappings，就會覆蓋 index template 的設定</p>
</li>
</ol>
<p>以下透過簡單範例，說明 index template 的建立跟使用時實際的流程：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//建立 default index template</span></span><br><span class="line"><span class="comment">//並設定 order = 0</span></span><br><span class="line">PUT _template/template_default</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"index_patterns"</span>: [<span class="string">"*"</span>],</span><br><span class="line">  <span class="attr">"order"</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"version"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"settings"</span>: &#123;</span><br><span class="line">    <span class="attr">"number_of_shards"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"number_of_replicas"</span>:<span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//設定 index 為 test 開頭的 index template</span></span><br><span class="line"><span class="comment">//並設定 order = 1</span></span><br><span class="line"><span class="comment">//因此 test 開頭的 index 會優先套用此設定</span></span><br><span class="line">PUT _template/template_test</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"index_patterns"</span> : [<span class="string">"test*"</span>],</span><br><span class="line">    <span class="attr">"order"</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"settings"</span> : &#123;</span><br><span class="line">    	<span class="attr">"number_of_shards"</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="comment">//調整 replica 的數量</span></span><br><span class="line">      <span class="attr">"number_of_replicas"</span> : <span class="number">2</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"mappings"</span> : &#123;</span><br><span class="line">    	<span class="comment">//取消日期的偵測</span></span><br><span class="line">      <span class="attr">"date_detection"</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="comment">//開啟數字的偵測</span></span><br><span class="line">    	<span class="attr">"numeric_detection"</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//查詢單一 index template 內容</span></span><br><span class="line">GET /_template/template_default</span><br><span class="line"><span class="comment">//查詢所有 "temp" 開頭的 index template 資訊</span></span><br><span class="line">GET /_template/temp*</span><br><span class="line"></span><br><span class="line"><span class="comment">//新增一個名稱為 testtemplate 的 index，並新增一筆資料</span></span><br><span class="line"><span class="comment">//由於名稱為 test 開頭，因此會套用 template_test 的設定</span></span><br><span class="line">PUT testtemplate/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">	<span class="attr">"someNumber"</span>:<span class="string">"1"</span>,</span><br><span class="line">	<span class="attr">"someDate"</span>:<span class="string">"2019/01/01"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//日期不會被偵測，而被當作一般的 text，而數字則是會偵測為 long</span></span><br><span class="line">GET testtemplate/_mapping</span><br><span class="line"><span class="comment">//shard = 1, replica = 2</span></span><br><span class="line">get testtemplate/_setting</span><br><span class="line"></span><br><span class="line"><span class="comment">//新增一個 index，並自行指定 settings</span></span><br><span class="line"><span class="comment">//自行指定 settings 就會覆蓋 index template 中的所有設定</span></span><br><span class="line">PUT testmy</span><br><span class="line">&#123;</span><br><span class="line">	<span class="attr">"settings"</span>:&#123;</span><br><span class="line">		<span class="attr">"number_of_replicas"</span>:<span class="number">5</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//新增資料到 testmy index 中</span></span><br><span class="line">put testmy/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"key"</span>:<span class="string">"value"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//index template 中的 settings 被覆蓋成上面指定的 "number_of_replicas":5</span></span><br><span class="line">get testmy/_settings</span><br><span class="line"></span><br><span class="line"><span class="comment">//移除 index</span></span><br><span class="line">DELETE testmy</span><br><span class="line">DELETE /_template/template_default</span><br><span class="line">DELETE /_template/template_test</span><br></pre></td></tr></table></figure>

<h2 id="Dynamic-Template"><a href="#Dynamic-Template" class="headerlink" title="Dynamic Template"></a>Dynamic Template</h2><p>dynamic template 相較於前面提到的 index template，擁有比較彈性的方式來制定 template，例如：</p>
<ul>
<li><p>將所有 field 都設定成 keyword，或是關閉 keyword field</p>
</li>
<li><p>將 <code>is</code> 開頭的 field 都設定為 boolean</p>
</li>
<li><p>將 <code>long</code> 開頭的 field 都設定為 long 類型</p>
</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用內建的自動辨識</span></span><br><span class="line">PUT my_index/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"firstName"</span>:<span class="string">"Ruan"</span>,</span><br><span class="line">  <span class="attr">"isVIP"</span>:<span class="string">"true"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//可以發現 firstName &amp; isVIP 都被辨識成 text</span></span><br><span class="line">GET my_index/_mapping</span><br></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//移除原本的 index</span></span><br><span class="line">DELETE my_index</span><br><span class="line"></span><br><span class="line"><span class="comment">//為 index 設定 dynamic template</span></span><br><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"mappings"</span>: &#123;</span><br><span class="line">    <span class="attr">"dynamic_templates"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">        <span class="attr">"strings_as_boolean"</span>: &#123;</span><br><span class="line">          <span class="attr">"match_mapping_type"</span>:   <span class="string">"string"</span>,</span><br><span class="line">          <span class="comment">//"is" 開頭的 field 設定為 boolean</span></span><br><span class="line">          <span class="attr">"match"</span>:<span class="string">"is*"</span>,</span><br><span class="line">          <span class="attr">"mapping"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"boolean"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"strings_as_keywords"</span>: &#123;</span><br><span class="line">          <span class="attr">"match_mapping_type"</span>:   <span class="string">"string"</span>,</span><br><span class="line">          <span class="comment">//其他的部份則設定為 keyword</span></span><br><span class="line">          <span class="attr">"mapping"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//firstName 會變成 keyword</span></span><br><span class="line"><span class="comment">//isVIP 會變成 boolean</span></span><br><span class="line">PUT my_index/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"firstName"</span>:<span class="string">"Ruan"</span>,</span><br><span class="line">  <span class="attr">"isVIP"</span>:<span class="string">"true"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET my_index/_mapping</span><br></pre></td></tr></table></figure>

<p>一個以 path 為基礎，並搭配較為複雜處理的設定：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//移除原本的 index</span></span><br><span class="line">DELETE my_index</span><br><span class="line"></span><br><span class="line"><span class="comment">// 設定 dynamic template，以 path match 為基礎</span></span><br><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"mappings"</span>: &#123;</span><br><span class="line">    <span class="attr">"dynamic_templates"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"full_name"</span>: &#123;</span><br><span class="line">          <span class="comment">//若符合以下 path 的 match &amp; unmatch 條件</span></span><br><span class="line">          <span class="attr">"path_match"</span>:   <span class="string">"name.*"</span>,</span><br><span class="line">          <span class="attr">"path_unmatch"</span>: <span class="string">"*.middle"</span>,</span><br><span class="line">          <span class="comment">//將資料複製一份到 full_name 欄位</span></span><br><span class="line">          <span class="attr">"mapping"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>:       <span class="string">"text"</span>,</span><br><span class="line">            <span class="attr">"copy_to"</span>:    <span class="string">"full_name"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT my_index/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: &#123;</span><br><span class="line">    <span class="attr">"first"</span>:  <span class="string">"John"</span>,</span><br><span class="line">    <span class="attr">"middle"</span>: <span class="string">"Winston"</span>,</span><br><span class="line">    <span class="attr">"last"</span>:   <span class="string">"Lennon"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//後面就可以使用額外加入的 full_name 進行搜尋</span></span><br><span class="line"><span class="comment">//full_name 不會出現在 _source 中</span></span><br><span class="line">GET my_index/_search?q=full_name:John</span><br></pre></td></tr></table></figure>


<h1 id="Elasticsearch-聚合分析簡介"><a href="#Elasticsearch-聚合分析簡介" class="headerlink" title="Elasticsearch 聚合分析簡介"></a>Elasticsearch 聚合分析簡介</h1><h2 id="Aggregation"><a href="#Aggregation" class="headerlink" title="Aggregation"></a>Aggregation</h2><ul>
<li><p>Elasticsearc 除了一般的搜尋之外，也可透過 aggergation 的方式，提供數據統計分析的功能，可作到很即時的查詢</p>
</li>
<li><p>透過 aggregation 可以得到分析 &amp; 總結數據後的總覽，而非單一 document，例如：</p>
<ul>
<li><p>某特定區域剩餘的客房數量</p>
</li>
<li><p>進行不同價格區間的搜尋，可預定的平價旅館 &amp; 五星級酒店的數量</p>
</li>
</ul>
</li>
<li><p>效能很好，在 ES 端就可以得到分析結果，不用在 client 端開發分析邏輯</p>
</li>
<li><p>許多 Kibana 報表中的元素都可以透過 aggregation 的數據來完成。例如：</p>
<ul>
<li><p>公司員工的職位分佈、薪水分佈</p>
</li>
<li><p>客戶所在的地理位置分佈</p>
</li>
<li><p>訂單的增減狀況</p>
</li>
</ul>
</li>
</ul>
<h2 id="Aggregation-Family-聚合總類"><a href="#Aggregation-Family-聚合總類" class="headerlink" title="Aggregation Family (聚合總類)"></a>Aggregation Family (聚合總類)</h2><ul>
<li><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket.html" target="_blank" rel="noopener">Bucket Aggregation</a>：滿足特定條件的 document 集合 (類似傳統 SQL 語法中的 <code>Group By</code>)</p>
</li>
<li><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-metrics.html" target="_blank" rel="noopener">Metric Aggregation</a>：可透過數學運算，對 document filed 進行統計分析</p>
<ul>
<li><p>基於數據集合計算結果；除了支援在 field 上進行計算，也支援在 (painless) script 產生的結果之上進行計算</p>
</li>
<li><p>大多數的 metric 是數學計算，只會輸出一個值，例如：<strong>min</strong> / <strong>max</strong> / <strong>sum</strong> / <strong>avg</strong> / <strong>cardinality</strong></p>
</li>
<li><p>部份的 metric 支援輸出多個值，例如：<strong>stats</strong> / <strong>percentiles</strong> / <strong>percentile_ranks</strong></p>
</li>
</ul>
</li>
</ul>
<p><img src="/blog/images/Elasticsearch/es_aggregation-01.png" alt="Elasticsearch - Bucket &amp; Metric aggregation"></p>
<ul>
<li><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-matrix.html" target="_blank" rel="noopener">Matrix Aggregation</a>：支援對多個 field 同時進行操作並提供一個結果矩陣</p>
</li>
<li><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-pipeline.html" target="_blank" rel="noopener">Pipiline Aggregation</a>: 對其他 aggregation 的結果再一次的進行 aggregation</p>
</li>
</ul>
<h2 id="範例：Bucketing-分桶"><a href="#範例：Bucketing-分桶" class="headerlink" title="範例：Bucketing (分桶)"></a>範例：Bucketing (分桶)</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根據目的地進行 bucketing 操作</span></span><br><span class="line">GET kibana_sample_data_flights/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"aggs"</span>:&#123;</span><br><span class="line">    <span class="attr">"flight_dest"</span>:&#123;</span><br><span class="line">      <span class="comment">//使用 terms 關鍵字，指定要進行 bucketing，使用的是 field DestCountry</span></span><br><span class="line">      <span class="attr">"terms"</span>:&#123;</span><br><span class="line">        <span class="attr">"field"</span>:<span class="string">"DestCountry"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="範例：Bucketing-Metric"><a href="#範例：Bucketing-Metric" class="headerlink" title="範例：Bucketing + Metric"></a>範例：Bucketing + Metric</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查看航班目的地的統計資訊，並以目的地為單位，額外增加平均，最高最低價格</span></span><br><span class="line">GET kibana_sample_data_flights/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"aggs"</span>:&#123;</span><br><span class="line">    <span class="comment">//先進行 bucket aggregation 操作</span></span><br><span class="line">    <span class="attr">"flight_dest"</span>:&#123;</span><br><span class="line">      <span class="attr">"terms"</span>:&#123;</span><br><span class="line">        <span class="attr">"field"</span>:<span class="string">"DestCountry"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">//根據上面結果再進行 metric aggregation 操作</span></span><br><span class="line">      <span class="attr">"aggs"</span>:&#123;</span><br><span class="line">        <span class="attr">"avg_price"</span>:&#123;</span><br><span class="line">          <span class="attr">"avg"</span>:&#123;</span><br><span class="line">            <span class="attr">"field"</span>:<span class="string">"AvgTicketPrice"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"max_price"</span>:&#123;</span><br><span class="line">          <span class="attr">"max"</span>:&#123;</span><br><span class="line">            <span class="attr">"field"</span>:<span class="string">"AvgTicketPrice"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"min_price"</span>:&#123;</span><br><span class="line">          <span class="attr">"min"</span>:&#123;</span><br><span class="line">            <span class="attr">"field"</span>:<span class="string">"AvgTicketPrice"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="範例：Bucketing-Metric-Matrix"><a href="#範例：Bucketing-Metric-Matrix" class="headerlink" title="範例：Bucketing + Metric + Matrix"></a>範例：Bucketing + Metric + Matrix</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查看航班目的地的統計資訊，並以目的地為單位，額外增加平均票價 &amp; 目的地天氣的統計資訊</span></span><br><span class="line">GET kibana_sample_data_flights/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"aggs"</span>:&#123;</span><br><span class="line">    <span class="attr">"flight_dest"</span>:&#123;</span><br><span class="line">      <span class="attr">"terms"</span>:&#123;</span><br><span class="line">        <span class="attr">"field"</span>:<span class="string">"DestCountry"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"aggs"</span>:&#123;</span><br><span class="line">        <span class="attr">"stats_price"</span>:&#123;</span><br><span class="line">          <span class="comment">//透過 stats 關鍵字可直接帶出 count/min/max/avg/sum ... 等資訊</span></span><br><span class="line">          <span class="attr">"stats"</span>:&#123;</span><br><span class="line">            <span class="attr">"field"</span>:<span class="string">"AvgTicketPrice"</span></span><br><span class="line">          &#125;</span><br><span class="line">				&#125;,</span><br><span class="line">        <span class="attr">"weather"</span>:&#123;</span><br><span class="line">          <span class="attr">"terms"</span>: &#123;</span><br><span class="line">            <span class="attr">"field"</span>: <span class="string">"DestWeather"</span>,</span><br><span class="line">            <span class="comment">//可限定輸出的資料數量，預設為 10</span></span><br><span class="line">            <span class="attr">"size"</span>: <span class="number">5</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="References-1"><a href="#References-1" class="headerlink" title="References"></a>References</h1><ul>
<li><p><a href="https://time.geekbang.org/course/intro/100030501" target="_blank" rel="noopener">Elasticsearch核心技術與實戰 | 極客時間</a></p>
</li>
<li><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html" target="_blank" rel="noopener">Elasticsearch Reference [7.4] | Elastic</a></p>
</li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/blog/tags/Elasticsearch/" rel="tag"># Elasticsearch</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/blog/DevOps/terraform-input-variables/" rel="prev" title="[Terraform] Input Variables ">
      <i class="fa fa-chevron-left"></i> [Terraform] Input Variables 
    </a></div>
      <div class="post-nav-item">
    <a href="/blog/Elasticsearch/Elasticsearch-advanced-search/" rel="next" title="[Elasticsearch] 深入搜索">
      [Elasticsearch] 深入搜索 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#基本概念：Index、Document-和-REST-API"><span class="nav-number">1.</span> <span class="nav-text">基本概念：Index、Document 和 REST API</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Document"><span class="nav-number">1.1.</span> <span class="nav-text">Document</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JSON-document"><span class="nav-number">1.2.</span> <span class="nav-text">JSON document</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#基本概念：Node、Cluster、Shard-及-Replication"><span class="nav-number">2.</span> <span class="nav-text">基本概念：Node、Cluster、Shard 及 Replication</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Document-的基本-CRUD-與批次操作"><span class="nav-number">3.</span> <span class="nav-text">Document 的基本 CRUD 與批次操作</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#API-行為區分"><span class="nav-number">3.1.</span> <span class="nav-text">API 行為區分</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Inverted-Index-倒排索引-介紹"><span class="nav-number">4.</span> <span class="nav-text">Inverted Index(倒排索引)介紹</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Inverted-Index-組成"><span class="nav-number">4.1.</span> <span class="nav-text">Inverted Index 組成</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Posting-List"><span class="nav-number">4.2.</span> <span class="nav-text">Posting List</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#References"><span class="nav-number">4.3.</span> <span class="nav-text">References</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#通過Analyzer進行分詞"><span class="nav-number">5.</span> <span class="nav-text">通過Analyzer進行分詞</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Analyzer-的組成"><span class="nav-number">5.1.</span> <span class="nav-text">Analyzer 的組成</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Elasticsearch-內建的-Analyzer"><span class="nav-number">5.2.</span> <span class="nav-text">Elasticsearch 內建的 Analyzer</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Search-API-概覽"><span class="nav-number">6.</span> <span class="nav-text">Search API 概覽</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#URI-查詢"><span class="nav-number">6.1.</span> <span class="nav-text">URI 查詢</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#衡量相關性"><span class="nav-number">6.2.</span> <span class="nav-text">衡量相關性</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#URI-Search詳解"><span class="nav-number">7.</span> <span class="nav-text">URI Search詳解</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#搜尋範例"><span class="nav-number">7.1.</span> <span class="nav-text">搜尋範例</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Request-Body-與-Query-DSL-簡介"><span class="nav-number">8.</span> <span class="nav-text">Request Body 與 Query DSL 簡介</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#一般查詢範例"><span class="nav-number">8.1.</span> <span class="nav-text">一般查詢範例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Scripted-Field-腳本字段-Query"><span class="nav-number">8.2.</span> <span class="nav-text">Scripted Field(腳本字段) Query</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用查詢表達式-Match"><span class="nav-number">8.3.</span> <span class="nav-text">使用查詢表達式 - Match</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用查詢表達式-Match-Phrase"><span class="nav-number">8.4.</span> <span class="nav-text">使用查詢表達式 - Match Phrase</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Query-String-amp-Simple-Query-String-查詢"><span class="nav-number">9.</span> <span class="nav-text">Query String &amp; Simple Query String 查詢</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Query-String-Query"><span class="nav-number">9.1.</span> <span class="nav-text">Query String Query</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Simple-Query-String-Query"><span class="nav-number">9.2.</span> <span class="nav-text">Simple Query String Query</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Dynamic-Mapping-和常見字段類型"><span class="nav-number">10.</span> <span class="nav-text">Dynamic Mapping 和常見字段類型</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#What-is-Mapping"><span class="nav-number">10.1.</span> <span class="nav-text">What is Mapping ?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Term-Data-Type"><span class="nav-number">10.2.</span> <span class="nav-text">Term Data Type</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#簡單類型"><span class="nav-number">10.2.1.</span> <span class="nav-text">簡單類型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#複雜類型"><span class="nav-number">10.2.2.</span> <span class="nav-text">複雜類型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#特殊類型"><span class="nav-number">10.2.3.</span> <span class="nav-text">特殊類型</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#What-is-Dynamic-Mapping"><span class="nav-number">10.3.</span> <span class="nav-text">What is Dynamic Mapping ?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#範例"><span class="nav-number">10.4.</span> <span class="nav-text">範例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#修改-Mapping-中的字段類型"><span class="nav-number">10.5.</span> <span class="nav-text">修改 Mapping 中的字段類型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#修改-Mapping-範例"><span class="nav-number">10.6.</span> <span class="nav-text">修改 Mapping 範例</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#顯式-Mapping-設置與常見參數介紹"><span class="nav-number">11.</span> <span class="nav-text">顯式 Mapping 設置與常見參數介紹</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#自定義-mapping"><span class="nav-number">11.1.</span> <span class="nav-text">自定義 mapping</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Index-Options"><span class="nav-number">11.2.</span> <span class="nav-text">Index Options</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#選擇性的讓特定-Field-不被索引"><span class="nav-number">11.3.</span> <span class="nav-text">選擇性的讓特定 Field 不被索引</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NULL-value-的處理"><span class="nav-number">11.4.</span> <span class="nav-text">NULL value 的處理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#copy-to-設定"><span class="nav-number">11.5.</span> <span class="nav-text">copy_to 設定</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Aray-Type"><span class="nav-number">11.6.</span> <span class="nav-text">Aray Type</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Multiple-Field-特性及-Mapping-中配置自定義-Analyzer"><span class="nav-number">12.</span> <span class="nav-text">Multiple Field 特性及 Mapping 中配置自定義 Analyzer</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Exact-Values-v-s-Full-Text"><span class="nav-number">12.1.</span> <span class="nav-text">Exact Values v.s. Full Text</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#自訂分詞器-Analyzer"><span class="nav-number">12.2.</span> <span class="nav-text">自訂分詞器(Analyzer)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Character-Filter"><span class="nav-number">12.2.1.</span> <span class="nav-text">Character Filter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tokenizer"><span class="nav-number">12.2.2.</span> <span class="nav-text">Tokenizer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Token-Filter"><span class="nav-number">12.2.3.</span> <span class="nav-text">Token Filter</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#範例-1"><span class="nav-number">12.3.</span> <span class="nav-text">範例</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Index-Template-和-Dynamic-Template"><span class="nav-number">13.</span> <span class="nav-text">Index Template 和 Dynamic Template</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Index-Template"><span class="nav-number">13.1.</span> <span class="nav-text">Index Template</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Dynamic-Template"><span class="nav-number">13.2.</span> <span class="nav-text">Dynamic Template</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Elasticsearch-聚合分析簡介"><span class="nav-number">14.</span> <span class="nav-text">Elasticsearch 聚合分析簡介</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Aggregation"><span class="nav-number">14.1.</span> <span class="nav-text">Aggregation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Aggregation-Family-聚合總類"><span class="nav-number">14.2.</span> <span class="nav-text">Aggregation Family (聚合總類)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#範例：Bucketing-分桶"><span class="nav-number">14.3.</span> <span class="nav-text">範例：Bucketing (分桶)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#範例：Bucketing-Metric"><span class="nav-number">14.4.</span> <span class="nav-text">範例：Bucketing + Metric</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#範例：Bucketing-Metric-Matrix"><span class="nav-number">14.5.</span> <span class="nav-text">範例：Bucketing + Metric + Matrix</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#References-1"><span class="nav-number">15.</span> <span class="nav-text">References</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">godleon</p>
  <div class="site-description" itemprop="description">把時間花在哪裡，成就就在哪裡</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog/archives/">
        
          <span class="site-state-item-count">120</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/blog/categories/">
          
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/blog/tags/">
          
        <span class="site-state-item-count">92</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">godleon</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/blog/lib/anime.min.js"></script>
  <script src="/blog/lib/velocity/velocity.min.js"></script>
  <script src="/blog/lib/velocity/velocity.ui.min.js"></script>

<script src="/blog/js/utils.js"></script>

<script src="/blog/js/motion.js"></script>


<script src="/blog/js/schemes/muse.js"></script>


<script src="/blog/js/next-boot.js"></script>




  















  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://godleon-blog-hexo.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  var disqus_config = function() {
    this.page.url = "https://godleon.github.io/blog/Elasticsearch/Elasticsearch-getting-started/";
    this.page.identifier = "Elasticsearch/Elasticsearch-getting-started/";
    this.page.title = "[Elasticsearch] 基本概念 & 搜尋入門";
    };
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://godleon-blog-hexo.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

</body>
</html>
