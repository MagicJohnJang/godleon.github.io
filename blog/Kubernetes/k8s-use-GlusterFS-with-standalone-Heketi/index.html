<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-tw">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/blog/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/blog/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/blog/css/main.css?v=5.1.3" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/blog/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Kubernetes,CKA,GlusterFS,">










<meta name="description" content="此篇文章介紹如何快速的安裝 GlusterFS + Heketi 並與 Kubernetes 中的 StorageClass 搭配使用">
<meta name="keywords" content="Kubernetes,CKA,GlusterFS">
<meta property="og:type" content="article">
<meta property="og:title" content="[Kubernetes] 快速安裝 GlusterFS + Heketi 並與 StorageClass 搭配使用">
<meta property="og:url" content="https://godleon.github.io/blog/Kubernetes/k8s-use-GlusterFS-with-standalone-Heketi/index.html">
<meta property="og:site_name" content="小信豬的原始部落">
<meta property="og:description" content="此篇文章介紹如何快速的安裝 GlusterFS + Heketi 並與 Kubernetes 中的 StorageClass 搭配使用">
<meta property="og:locale" content="zh-tw">
<meta property="og:updated_time" content="2018-10-26T21:22:23.036Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="[Kubernetes] 快速安裝 GlusterFS + Heketi 並與 StorageClass 搭配使用">
<meta name="twitter:description" content="此篇文章介紹如何快速的安裝 GlusterFS + Heketi 並與 Kubernetes 中的 StorageClass 搭配使用">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/blog/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://godleon.github.io/blog/Kubernetes/k8s-use-GlusterFS-with-standalone-Heketi/">





  <title>[Kubernetes] 快速安裝 GlusterFS + Heketi 並與 StorageClass 搭配使用 | 小信豬的原始部落</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-703592-7', 'auto');
  ga('send', 'pageview');
</script>





</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-tw">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/blog/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">小信豬的原始部落</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/blog/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首頁
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/blog/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            標籤
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/blog/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分類
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/blog/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            歸檔
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            檢索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://godleon.github.io/blog/blog/Kubernetes/k8s-use-GlusterFS-with-standalone-Heketi/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="godleon">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小信豬的原始部落">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">[Kubernetes] 快速安裝 GlusterFS + Heketi 並與 StorageClass 搭配使用</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              
              <time title="創建於" itemprop="dateCreated datePublished" datetime="2018-09-26T06:50:00+00:00">
                2018-09-26
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Kubernetes/" itemprop="url" rel="index">
                    <span itemprop="name">Kubernetes</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/blog/Kubernetes/k8s-use-GlusterFS-with-standalone-Heketi/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="Kubernetes/k8s-use-GlusterFS-with-standalone-Heketi/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          
              <div class="post-description">
                  此篇文章介紹如何快速的安裝 GlusterFS + Heketi 並與 Kubernetes 中的 StorageClass 搭配使用
              </div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>此篇文章介紹如何快速的安裝 GlusterFS + Heketi 並與 Kubernetes 中的 StorageClass 搭配使用 </p>
<h1 id="緣由"><a href="#緣由" class="headerlink" title="緣由"></a>緣由</h1><p>由於最近在花些時間研究 k8s，但一直研究到 <a href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/" target="_blank" rel="noopener">StatefulSet</a> 時，發現對於 StatefulSet 來說，<strong>persistet volume 是必備的</strong>，而且若是有設定 replica 的部份，就演變成 <strong>動態產生 persistent volume 是必備</strong> 的。</p>
<p>動態產生 PV 這個需求的確是存在的，試想如果有很多不同的 workload or job 都在 k8s 上運行，但同時都需要保存資料時，每次都請 storage manager 開好 PV 是很麻煩的，因此把這個部份的自動化的需求就產生了；而動態產生 <strong>PV</strong>(persistent volume) 這件工作，在 k8s 是由 <a href="https://kubernetes.io/docs/concepts/storage/storage-classes/" target="_blank" rel="noopener">Storage Class</a> 這個機制來完成；於是仔細看了一下 provisioner list，決定使用 GlusterFS 來作為 persistent storage 的測試對象。</p>
<blockquote>
<p>選擇 GlusterFS 的原因是因為同時支援 ReadWriteOnce/ReadOnlyMany/ReadWriteMany 三種 <a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#access-modes" target="_blank" rel="noopener">Access Mode</a>，同時也支援 Quota &amp; Snapshot 等功能</p>
</blockquote>
<h1 id="What-is-GlusterFS"><a href="#What-is-GlusterFS" class="headerlink" title="What is GlusterFS?"></a>What is GlusterFS?</h1><p>這個部份就不多著墨，詳細的內容可以參考以下網站：</p>
<ul>
<li><a href="http://www.l-penguin.idv.tw/book/Gluster-Storage_GitBook/gluster_intra/gluster_arch.html" target="_blank" rel="noopener">Gluster 架構 | Gluster Storage System</a></li>
</ul>
<p>上面有提到關於一些 GlsuterFS 重要的概念，例如：<strong>Peer</strong>, <strong>Brick</strong>, <strong>Volume</strong> …. 等等。</p>
<p>若對 GlusterFS 的運作細節跟優化很有興趣，可以參考<a href="https://docs.gluster.org/en/latest/" target="_blank" rel="noopener">官方的文件說明</a>。</p>
<h1 id="What-is-Heketi"><a href="#What-is-Heketi" class="headerlink" title="What is Heketi?"></a>What is Heketi?</h1><p>首先看看以下官網的說明：</p>
<blockquote>
<p>Heketi provides a RESTful management interface which can be used to manage the life cycle of GlusterFS volumes. With Heketi, cloud services like OpenStack Manila, Kubernetes, and OpenShift can dynamically provision GlusterFS volumes with any of the supported durability types. Heketi will automatically determine the location for bricks across the cluster, making sure to place bricks and its replicas across different failure domains. Heketi also supports any number of GlusterFS clusters, allowing cloud services to provide network file storage without being limited to a single GlusterFS cluster.</p>
</blockquote>
<p>首先關於 GlusterFS，必須知道以下幾件事情：</p>
<ul>
<li><p>GlusterFS 並沒有提供管理用的 REST API service</p>
</li>
<li><p>GlusterFS 並沒有提供 Failure Domain 的設計</p>
</li>
</ul>
<p>而以上兩個在 GlusterFS 中沒有的設計，Heketi 則是在更上層的抽象設計中，把這兩個功能補足了! 因此細部檢視 Heketi 的功能，就包含了：</p>
<ul>
<li><p>提供 REST API service 作為管理 GlusterFS 之用</p>
</li>
<li><p>可以讓 OpenStack Manila, Kubernetes, OpenShift 等平台動態產生 volume 並掛載使用</p>
</li>
<li><p>可同時管理多個 GlusterFS cluster，可讓使用者把資料放到不同的 GlusterFS cluster 中</p>
</li>
<li><p>可根據需求，自動化的在分配 brick 時，分散到不同的 failure domain，提供資料可用性</p>
</li>
</ul>
<h1 id="環境需求"><a href="#環境需求" class="headerlink" title="環境需求"></a>環境需求</h1><h2 id="Kubernetes"><a href="#Kubernetes" class="headerlink" title="Kubernetes"></a>Kubernetes</h2><p>假設已經有一個正常運行的 Kubernetes</p>
<h2 id="GlusterFS"><a href="#GlusterFS" class="headerlink" title="GlusterFS"></a>GlusterFS</h2><p>GlusterFS 的環境安裝過程中，需要 2 個 node 來進行安裝，規格如下：</p>
<ul>
<li><p>OS: <code>Ubuntu 18.04 (Bionic)</code></p>
</li>
<li><p>CPU &amp; RAM: 由於只是測試環境….因此這邊只給 4 vcore + 4GB RAM</p>
</li>
<li><p>Disk: <code>3 (1 for OS, 2 for Data)</code> (<strong>/dev/vda</strong>, <strong>/dev/vdb</strong>, <strong>/dev/vdc</strong>)</p>
</li>
</ul>
<blockquote>
<p>以上的 node 建議需要設定成搭配 SSH pribate key 進行 passwordless 登入</p>
</blockquote>
<h2 id="Heketi"><a href="#Heketi" class="headerlink" title="Heketi"></a>Heketi</h2><p>以下安裝過程中，會將 Heketi 安裝在 GlusterFS cluster 的第一個 node 上，單獨以 docker container 的方式運行</p>
<h2 id="安裝用機器-Bootstrapper"><a href="#安裝用機器-Bootstrapper" class="headerlink" title="安裝用機器(Bootstrapper)"></a>安裝用機器(Bootstrapper)</h2><p>這台機器可以是實體機 or VM，使用的環境必須為 <code>Ubuntu 18.04</code> or <code>Ubuntu 16.04</code></p>
<h1 id="安裝事前準備"><a href="#安裝事前準備" class="headerlink" title="安裝事前準備"></a>安裝事前準備</h1><h2 id="取得安裝程式"><a href="#取得安裝程式" class="headerlink" title="取得安裝程式"></a>取得安裝程式</h2><p>首先登入到 bootstrapper，輸入以下指令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get update &amp;&amp; sudo apt-get -y install git</span><br><span class="line">$ <span class="built_in">cd</span> /tmp</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/godleon/k8s-lab.git</span><br><span class="line">$ <span class="built_in">cd</span> /tmp/k8s-lab/GlusterFS-with-standalone-Heketi/ansible</span><br></pre></td></tr></table></figure>
<h2 id="修改安裝參數檔"><a href="#修改安裝參數檔" class="headerlink" title="修改安裝參數檔"></a>修改安裝參數檔</h2><p>以下的安裝參數檔請按照自己的環境進行修改：</p>
<h3 id="pwd-inventory"><a href="#pwd-inventory" class="headerlink" title="$(pwd)/inventory"></a>$(pwd)/inventory</h3><p>此檔案包含了用來安裝 GlusterFS 的兩個 node 的名稱 &amp; IP 資訊</p>
<h3 id="pwd-group-vars-all"><a href="#pwd-group-vars-all" class="headerlink" title="$(pwd)/group_vars/all"></a>$(pwd)/group_vars/all</h3><p>這裡包含三種資訊：</p>
<ol>
<li><p>每個 node 的 <strong>SSH 連線資訊</strong>(因為安裝程式是使用 Ansible 所開發，因此正確的 SSH 連線資訊是必備的)</p>
</li>
<li><p>GlusterFS 的<strong>版本</strong> (預設為 <code>4.1</code>)</p>
</li>
<li><p>每個 node 上用來儲存資料的 <strong>device name</strong> (也可以是 <strong>partition name</strong>)</p>
</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Login information of GlusterFS nodes</span></span><br><span class="line"><span class="attr">ansible_python_interpreter:</span> <span class="string">/usr/bin/python3</span></span><br><span class="line"><span class="attr">ansible_user:</span> <span class="string">"ubuntu"</span></span><br><span class="line"><span class="attr">ansible_become_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">ansible_ssh_private_key_file:</span> <span class="string">/ansible/ssh-privkey/id_rsa</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># GlusterFS version</span></span><br><span class="line"><span class="attr">glusterfs_version:</span> <span class="string">"4.1"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># disk list for storing data (not OS disk)</span></span><br><span class="line"><span class="attr">storage_devs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">"/dev/vdb"</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">"/dev/vdc"</span></span><br></pre></td></tr></table></figure>
<h2 id="準備-SSH-Private-Key"><a href="#準備-SSH-Private-Key" class="headerlink" title="準備 SSH Private Key"></a>準備 SSH Private Key</h2><p>將用來登入 GlusterFS node 用的 ssh private key 放到 <code>$(pwd)/ssh-privkey</code> 目錄中，並命名為 <strong>id_rsa</strong>。</p>
<h1 id="安裝程式做了那些事情"><a href="#安裝程式做了那些事情" class="headerlink" title="安裝程式做了那些事情?"></a>安裝程式做了那些事情?</h1><p>在開始安裝之前，先說明一下整個安裝程式到底完成了那些事情：</p>
<ol>
<li><p>在 2 個乾淨的 node 上安裝 GlusterFS，並設定 peer(這是一個 GlusterFS cluster node 之間相互認識的一個過程)</p>
</li>
<li><p>在第一個 node 上安裝 docker</p>
</li>
<li><p>透過 docker 啟動 Heketi service container</p>
</li>
<li><p>匯入 cluster topology 資訊到 Heketi service</p>
<blockquote>
<p>topology 資訊包含 hostname, IP, 用來儲存 data 的 device(or partition name), failure domain … 等資訊</p>
</blockquote>
</li>
<li><p>取得新建立的 cluster ID 並顯示</p>
</li>
</ol>
<p>有了最後一個步驟取得的 cluster ID 後，才可以用來設定 k8s StorageClass for GlusterFS。</p>
<h1 id="開始安裝"><a href="#開始安裝" class="headerlink" title="開始安裝"></a>開始安裝</h1><p>執行以下命令開始安裝：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /tmp/k8s-lab/GlusterFS-with-standalone-Heketi</span><br><span class="line">$ ./start.sh</span><br></pre></td></tr></table></figure>
<p>接著安裝程式會開始執行，大概需要 3~5 分鐘完成所有的安裝流程，而安裝完成後會出現類似以下訊息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">....(略)</span><br><span class="line">TASK [Display topology import result] ******************************************</span><br><span class="line">Wednesday 26 September 2018  05:49:15 +0000 (0:00:10.832)       0:02:01.148 *** </span><br><span class="line">skipping: [gfs02]</span><br><span class="line">ok: [gfs01] =&gt; &#123;</span><br><span class="line">    &quot;import_result.stdout_lines&quot;: [</span><br><span class="line">        &quot;Creating cluster ... ID: 6190e1bfdb33d611af35361d7f72625b&quot;, </span><br><span class="line">        &quot;\tAllowing file volumes on cluster.&quot;, </span><br><span class="line">        &quot;\tAllowing block volumes on cluster.&quot;, </span><br><span class="line">        &quot;\tCreating node 10.107.13.101 ... ID: 18db1bc118707ed70e26213b484068c2&quot;, </span><br><span class="line">        &quot;\t\tAdding device /dev/vdb ... OK&quot;, </span><br><span class="line">        &quot;\t\tAdding device /dev/vdc ... OK&quot;, </span><br><span class="line">        &quot;\tCreating node 10.107.13.102 ... ID: 900110afd1dff7c89c8fd7ef427f4337&quot;, </span><br><span class="line">        &quot;\t\tAdding device /dev/vdb ... OK&quot;, </span><br><span class="line">        &quot;\t\tAdding device /dev/vdc ... OK&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">....(略)</span><br><span class="line">TASK [Display Cluster ID] ******************************************************</span><br><span class="line">Wednesday 26 September 2018  05:49:16 +0000 (0:00:00.116)       0:02:01.970 *** </span><br><span class="line">skipping: [gfs02]</span><br><span class="line">ok: [gfs01] =&gt; &#123;</span><br><span class="line">    &quot;msg&quot;: &quot;Cluster ID = 6190e1bfdb33d611af35361d7f72625b&quot;</span><br><span class="line">&#125;</span><br><span class="line">....(略)</span><br></pre></td></tr></table></figure>
<p>從上面可以看到 topology 資訊匯入到 Heketi 所產生的回應訊息 &amp; Cluster ID，其中 <strong>Cluster ID</strong>(上面 Cluster ID = <code>6190e1bfdb33d611af35361d7f72625b</code>) 會在下一個步驟中使用到。</p>
<h1 id="Kubernetes-Cluster-設定"><a href="#Kubernetes-Cluster-設定" class="headerlink" title="Kubernetes Cluster 設定"></a>Kubernetes Cluster 設定</h1><p>由於要掛載 GlusterFS volume，因此在<strong>每個 worker node</strong> 上都必須要準備好 GlusterFS client 才行，由於實驗的 k8s 環境是安裝在 Ubuntu 上，因此可以透過以下指令安裝 GlusterFS client：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo add-apt-repository ppa:gluster/glusterfs-4.1 -y</span><br><span class="line">$ sudo apt-get -y install glusterfs-client</span><br></pre></td></tr></table></figure>
<p>若是 worker node 是 CentOS，可用下面指令安裝 GlusterFS client：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ yum -y install centos-release-gluster41</span><br><span class="line">$ yum install -y glusterfs-fuse</span><br></pre></td></tr></table></figure>
<p>這個部份若是漏掉了，會出現 <strong>mount: unknown filesystem type ‘glusterfs’</strong> 錯誤，在 pod 生成的時候會出現類似下面的訊息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">the following error information was pulled from the glusterfs log to help diagnose this issue: could not open log file for pod web-0</span><br><span class="line">  Warning  FailedMount  1m  kubelet, leon-k8s-node03  MountVolume.SetUp failed for volume &quot;pvc-6f3abcc5-bfec-11e8-885a-627e9087949f&quot; : mount failed: mount failed: exit status 32</span><br><span class="line">Mounting command: systemd-run</span><br><span class="line">Mounting arguments: --description=Kubernetes transient mount for /var/lib/kubelet/pods/6f3b9642-bfec-11e8-885a-627e9087949f/volumes/kubernetes.io~glusterfs/pvc-6f3abcc5-bfec-11e8-885a-627e9087949f --scope -- mount -t glusterfs -o auto_unmount,log-level=ERROR,log-file=/var/lib/kubelet/plugins/kubernetes.io/glusterfs/pvc-6f3abcc5-bfec-11e8-885a-627e9087949f/web-0-glusterfs.log,backup-volfile-servers=10.107.13.101:10.107.13.102:10.107.13.103 10.107.13.101:vol_e3f5e3f4faf604ab10014c9d1a274624 /var/lib/kubelet/pods/6f3b9642-bfec-11e8-885a-627e9087949f/volumes/kubernetes.io~glusterfs/pvc-6f3abcc5-bfec-11e8-885a-627e9087949f</span><br><span class="line">Output: Running scope as unit run-ra3dac606d12c48fc9cdf4667bf5a9963.scope.</span><br><span class="line">mount: unknown filesystem type &apos;glusterfs&apos;</span><br></pre></td></tr></table></figure>
<h1 id="測試-Kubernetes-與-Heketi-的連結"><a href="#測試-Kubernetes-與-Heketi-的連結" class="headerlink" title="測試 Kubernetes 與 Heketi 的連結"></a>測試 Kubernetes 與 Heketi 的連結</h1><p>在上面有提到 Heketi service 將會裝在第一個 node 上(<strong>gfs01</strong>, IP=<strong>10.107.13.101</strong>)，以 docker container 的方式提供服務；而且為了安裝方便，有些參數已經寫死在參數檔中(例如：admin password)，因此這邊可以彙整出以下資訊：</p>
<ul>
<li><p>GlusterFS cluster ID: <code>6190e1bfdb33d611af35361d7f72625b</code></p>
</li>
<li><p>Heketi service URL: <code>http://10.107.13.101:8080</code></p>
</li>
<li><p>admin password: <code>admin_key</code></p>
</li>
</ul>
<p>有了以上的資訊後，就可以往下進行與 k8s 的整合測試。</p>
<h2 id="建立-Storage-Class"><a href="#建立-Storage-Class" class="headerlink" title="建立 Storage Class"></a>建立 Storage Class</h2><p>在安裝程式中，預設 admin 的密碼為 <code>admin_key</code>，在 k8s 中可以透過 <a href="https://kubernetes.io/docs/concepts/configuration/secret/" target="_blank" rel="noopener">secret</a> 的方式帶入：</p>
<ul>
<li>檔名：<code>gfs-storageclass.yml</code></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">heketi-secret</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="comment"># echo -n "admin_key" | base64</span></span><br><span class="line"><span class="attr">  key:</span> <span class="string">YWRtaW5fa2V5</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">kubernetes.io/glusterfs</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">"my-gfs-storageclass"</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="comment"># 設定為預設的 storage class</span></span><br><span class="line">    <span class="string">storageclass.kubernetes.io/is-default-class:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">kubernetes.io/glusterfs</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line"><span class="attr">  resturl:</span> <span class="string">"http://10.107.13.101:8080"</span></span><br><span class="line"><span class="attr">  clusterid:</span> <span class="string">"6190e1bfdb33d611af35361d7f72625b"</span></span><br><span class="line"><span class="attr">  restauthenabled:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">  restuser:</span> <span class="string">"admin"</span></span><br><span class="line"><span class="attr">  secretNamespace:</span> <span class="string">"default"</span></span><br><span class="line"><span class="attr">  secretName:</span> <span class="string">"heketi-secret"</span></span><br><span class="line"><span class="attr">  gidMin:</span> <span class="string">"40000"</span></span><br><span class="line"><span class="attr">  gidMax:</span> <span class="string">"50000"</span></span><br><span class="line"><span class="attr">  volumetype:</span> <span class="string">"replicate:2"</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f gfs-storageclass.yml</span><br><span class="line">secret/heketi-secret created</span><br><span class="line">storageclass.storage.k8s.io/my-gfs-storageclass created</span><br></pre></td></tr></table></figure>
<h2 id="建立-StatefulSet"><a href="#建立-StatefulSet" class="headerlink" title="建立 StatefulSet"></a>建立 StatefulSet</h2><p>這邊使用 StatefulSet 搭配 VolumeClaimTemplate 對 <code>my-gfs-storageclass</code> 進行 dynamic volume provisioning：</p>
<ul>
<li>檔名: <code>statefulset.yml</code></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">  serviceName:</span> <span class="string">"nginx"</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">k8s.gcr.io/nginx-slim:0.8</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">www</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line"><span class="attr">  volumeClaimTemplates:</span></span><br><span class="line"><span class="attr">  - metadata:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">www</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      accessModes:</span> <span class="string">[</span> <span class="string">"ReadWriteOnce"</span> <span class="string">]</span></span><br><span class="line"><span class="attr">      storageClassName:</span> <span class="string">"my-gfs-storageclass"</span></span><br><span class="line"><span class="attr">      resources:</span></span><br><span class="line"><span class="attr">        requests:</span></span><br><span class="line"><span class="attr">          storage:</span> <span class="number">1</span><span class="string">Gi</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f nginx.yml </span><br><span class="line">statefulset.apps/web created</span><br></pre></td></tr></table></figure>
<p>完成之後，可以看到 PV &amp; PVC 自動被建立，並 bind 到每個 pod 中：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 取得 pv 資訊</span></span><br><span class="line">$ kubectl get pv</span><br><span class="line">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS    CLAIM               STORAGECLASS          REASON    AGE</span><br><span class="line">pvc-0b8f49d6-c156-11e8-885a-627e9087949f   1Gi        RWO            Delete           Bound     default/www-web-1   my-gfs-storageclass             1m</span><br><span class="line">pvc-1d15ce12-c156-11e8-885a-627e9087949f   1Gi        RWO            Delete           Bound     default/www-web-2   my-gfs-storageclass             44s</span><br><span class="line">pvc-fdda23de-c155-11e8-885a-627e9087949f   1Gi        RWO            Delete           Bound     default/www-web-0   my-gfs-storageclass             1m</span><br><span class="line"></span><br><span class="line"><span class="comment"># 取得 pvc 資訊</span></span><br><span class="line">$ kubectl get pvc</span><br><span class="line">NAME        STATUS    VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE</span><br><span class="line">www-web-0   Bound     pvc-fdda23de-c155-11e8-885a-627e9087949f   1Gi        RWO            my-gfs-storageclass   2m</span><br><span class="line">www-web-1   Bound     pvc-0b8f49d6-c156-11e8-885a-627e9087949f   1Gi        RWO            my-gfs-storageclass   1m</span><br><span class="line">www-web-2   Bound     pvc-1d15ce12-c156-11e8-885a-627e9087949f   1Gi        RWO            my-gfs-storageclass   1m</span><br><span class="line"></span><br><span class="line"><span class="comment"># 剛剛佈署的 StatefulSet 也都完成佈署了</span></span><br><span class="line">$ kubectl get all</span><br><span class="line">NAME        READY     STATUS    RESTARTS   AGE</span><br><span class="line">pod/web-0   1/1       Running   0          2m</span><br><span class="line">pod/web-1   1/1       Running   0          2m</span><br><span class="line">pod/web-2   1/1       Running   0          1m</span><br><span class="line"></span><br><span class="line">NAME                                  TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">service/glusterfs-dynamic-www-web-0   ClusterIP   10.233.60.3   &lt;none&gt;        1/TCP     2m</span><br><span class="line">service/glusterfs-dynamic-www-web-1   ClusterIP   10.233.17.8   &lt;none&gt;        1/TCP     1m</span><br><span class="line">service/glusterfs-dynamic-www-web-2   ClusterIP   10.233.16.6   &lt;none&gt;        1/TCP     1m</span><br><span class="line">service/kubernetes                    ClusterIP   10.233.0.1    &lt;none&gt;        443/TCP   21d</span><br><span class="line"></span><br><span class="line">NAME                   DESIRED   CURRENT   AGE</span><br><span class="line">statefulset.apps/web   3         3         2m</span><br></pre></td></tr></table></figure>
<p>看到以上訊息，就表示 <strong>Kubernetes <--> Heketi <--> GlusterFS</--></--></strong> 三個不同服務的串接已經正確的設定完成。</p>
<h1 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h1><p>若是單獨使用 GlusterFS volume 的情況下，完整的流程應該分成兩大部份：</p>
<ul>
<li><p>安裝 GlusterFS</p>
<ul>
<li>建立 peer information</li>
<li>check peer status &amp; pool list</li>
</ul>
</li>
<li><p>設定 volume</p>
<ul>
<li>新增 volume (設定 replica &amp; 指定使用哪個 node 的 brick)</li>
<li>掛載 volume 並使用</li>
</ul>
</li>
</ul>
<p>而 Heketi 把第二個部份的工作都自動化了，因此在設定 Heketi 時，只要匯入所謂的 topology 資訊(每一次匯入則是新增一個 cluster)，告訴 Heketi 以下資訊：</p>
<ul>
<li><p>這個 cluster 有哪些 node</p>
</li>
<li><p>每個 node 可用來儲存 data 的 device(or partition) name</p>
</li>
<li><p>failure domain (這個尚不清楚可以達成什麼效果，但應該跟 data redundacy policy 有關係)</p>
</li>
</ul>
<p>接著，產生 brick &amp; volume 這種煩瑣的工作，就由 Heketi 來負責自動完成。</p>
<p>然而 Heketi 除了以上功能外，還可以同時管理多個 GlusterFS cluster，因此可以讓使用者在資料配置上不受限於單一 cluster，在規劃 &amp; 運用上也更有彈性；不但可以減輕 storage manager 的負擔，同時也藉由與 Kubernetes 的搭配，讓實際應用程式的開發者可以更專注在應用上，而非複雜的 infra 設定上。</p>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><ul>
<li><p><a href="http://www.l-penguin.idv.tw/book/Gluster-Storage_GitBook/" target="_blank" rel="noopener">Gluster Storage System</a></p>
</li>
<li><p><a href="https://github.com/heketi/heketi" target="_blank" rel="noopener">heketi/heketi: RESTful based volume management framework for GlusterFS</a></p>
</li>
<li><p><a href="https://github.com/heketi/heketi/blob/master/docs/admin/readme.md" target="_blank" rel="noopener">Heketi Documentation - Administration</a></p>
</li>
<li><p><a href="https://github.com/heketi/heketi/blob/master/docs/admin/topology.md" target="_blank" rel="noopener">Prepare Heketi Topology</a></p>
</li>
<li><p><a href="https://www.cnblogs.com/breezey/p/8849466.html" target="_blank" rel="noopener">独立部署GlusterFS+Heketi实现Kubernetes共享存储 - breezey - 博客园</a></p>
</li>
<li><p><a href="http://jamyy.us.to/blog/2014/03/6220.html" target="_blank" rel="noopener">GlusterFS 操作備忘 « Jamyy’s Weblog</a></p>
</li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/blog/tags/Kubernetes/" rel="tag"># Kubernetes</a>
          
            <a href="/blog/tags/CKA/" rel="tag"># CKA</a>
          
            <a href="/blog/tags/GlusterFS/" rel="tag"># GlusterFS</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/blog/Kubernetes/k8s-Deployment-Overview/" rel="next" title="[Kubernetes] Deployment Overview">
                <i class="fa fa-chevron-left"></i> [Kubernetes] Deployment Overview
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/blog/Kubernetes/k8s-StatefulSets-Overview/" rel="prev" title="[Kubernetes] StatefulSet Overview">
                [Kubernetes] StatefulSet Overview <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目錄
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            本站概覽
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">godleon</p>
              <p class="site-description motion-element" itemprop="description">把時間花在哪裡，成就就在哪裡</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/blog/archives/">
              
                  <span class="site-state-item-count">77</span>
                  <span class="site-state-item-name">文章</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/blog/categories/index.html">
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">分類</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/blog/tags/index.html">
                  <span class="site-state-item-count">32</span>
                  <span class="site-state-item-name">標籤</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/godleon" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-globe"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:godleon@gmail.com" target="_blank" title="E-Mail">
                    
                      <i class="fa fa-fw fa-globe"></i>E-Mail</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://plus.google.com/godleon" target="_blank" title="Google">
                    
                      <i class="fa fa-fw fa-google"></i>Google</a>
                </span>
              
            
          </div>

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#緣由"><span class="nav-number">1.</span> <span class="nav-text">緣由</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#What-is-GlusterFS"><span class="nav-number">2.</span> <span class="nav-text">What is GlusterFS?</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#What-is-Heketi"><span class="nav-number">3.</span> <span class="nav-text">What is Heketi?</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#環境需求"><span class="nav-number">4.</span> <span class="nav-text">環境需求</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Kubernetes"><span class="nav-number">4.1.</span> <span class="nav-text">Kubernetes</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GlusterFS"><span class="nav-number">4.2.</span> <span class="nav-text">GlusterFS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Heketi"><span class="nav-number">4.3.</span> <span class="nav-text">Heketi</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安裝用機器-Bootstrapper"><span class="nav-number">4.4.</span> <span class="nav-text">安裝用機器(Bootstrapper)</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#安裝事前準備"><span class="nav-number">5.</span> <span class="nav-text">安裝事前準備</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#取得安裝程式"><span class="nav-number">5.1.</span> <span class="nav-text">取得安裝程式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#修改安裝參數檔"><span class="nav-number">5.2.</span> <span class="nav-text">修改安裝參數檔</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#pwd-inventory"><span class="nav-number">5.2.1.</span> <span class="nav-text">$(pwd)/inventory</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pwd-group-vars-all"><span class="nav-number">5.2.2.</span> <span class="nav-text">$(pwd)/group_vars/all</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#準備-SSH-Private-Key"><span class="nav-number">5.3.</span> <span class="nav-text">準備 SSH Private Key</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#安裝程式做了那些事情"><span class="nav-number">6.</span> <span class="nav-text">安裝程式做了那些事情?</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#開始安裝"><span class="nav-number">7.</span> <span class="nav-text">開始安裝</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Kubernetes-Cluster-設定"><span class="nav-number">8.</span> <span class="nav-text">Kubernetes Cluster 設定</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#測試-Kubernetes-與-Heketi-的連結"><span class="nav-number">9.</span> <span class="nav-text">測試 Kubernetes 與 Heketi 的連結</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#建立-Storage-Class"><span class="nav-number">9.1.</span> <span class="nav-text">建立 Storage Class</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#建立-StatefulSet"><span class="nav-number">9.2.</span> <span class="nav-text">建立 StatefulSet</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#結論"><span class="nav-number">10.</span> <span class="nav-text">結論</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#References"><span class="nav-number">11.</span> <span class="nav-text">References</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">godleon</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 強力驅動</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主題 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/blog/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/blog/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/blog/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/blog/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/blog/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/blog/js/src/bootstrap.js?v=5.1.3"></script>



  


  

    
      <script id="dsq-count-scr" src="https://godleon-blog-hexo.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'https://godleon.github.io/blog/Kubernetes/k8s-use-GlusterFS-with-standalone-Heketi/';
          this.page.identifier = 'Kubernetes/k8s-use-GlusterFS-with-standalone-Heketi/';
          this.page.title = '[Kubernetes] 快速安裝 GlusterFS + Heketi 並與 StorageClass 搭配使用';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://godleon-blog-hexo.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  











<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="//unpkg.com/valine/dist/Valine.min.js"></script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/blog/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
